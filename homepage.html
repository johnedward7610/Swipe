<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Homepage</title>
<style>
.floating-post{--primary:#606CF9;--accent:#ff6e6e}
body{font-family:sans-serif;background:#f4f6ff;margin:0;padding:20px;}
.hotbar{display:flex;gap:10px;margin-bottom:14px}
.hotbar button{padding:10px 16px;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer;position:relative}
#feed{max-width:800px;margin:0 auto}
.post-card{background:#fff;padding:16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-bottom:16px}
.post-header{display:flex;align-items:center;gap:12px}
.avatar{width:48px;height:48px;border-radius:999px;background:linear-gradient(135deg,#cfe1ff,#e7dfff);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;overflow:hidden}
.post-name{font-weight:700;cursor:pointer}
.post-time{color:#777;font-size:12px}
.post-text{margin:12px 0;white-space:pre-wrap}
.post-images{display:flex;gap:8px;overflow:hidden;flex-wrap:wrap}
.post-images img, .post-images video{max-height:220px;border-radius:10px;object-fit:cover;cursor:pointer}
.actions{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
.like-btn{background:var(--accent);color:#fff}
.comment-btn{background:var(--primary);color:#fff}
.delete-btn{background:#222;color:#fff}
.share-btn{background:#888;color:#fff}
.likes-count{font-weight:700;margin-left:6px}
.views-count{color:#555;font-size:14px;margin-left:auto}
.comments-area{margin-top:10px;border-top:1px solid #eee;padding-top:10px}
.comment-card{background:#f6f7ff;padding:8px;border-radius:8px;margin-bottom:8px}
.floating-post{position:fixed;right:22px;bottom:22px;width:58px;height:58px;border-radius:999px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-size:32px;box-shadow:0 8px 24px rgba(0,0,0,.15);cursor:pointer}
.load-more{padding:12px;text-align:center;color:#555}
.follow-btn{padding:6px 10px;border-radius:8px;border:none;background:#fff;color:var(--primary);cursor:pointer}
textarea.comment-input{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:6px;resize:none}
.taggedUser{color:var(--primary);font-weight:700;cursor:pointer;margin-right:6px}
.shared-box{margin-top:10px;padding:10px;background:#f0f2ff;border-radius:10px}
.small-muted{font-size:13px;color:#666;margin-top:6px}
/* RED DOT FOR NOTIFICATIONS */
#notifDot {
  position: absolute;
  top:5px;
  right:5px;
  width:10px;
  height:10px;
  background:red;
  border-radius:50%;
  display:none;
}
</style>
</head>
<body>

<div class="hotbar">
  <button onclick="location.href='profile.html'">   <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="25px" height="25px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

  <title>profile_round [#1342]</title>
  <desc>Created with Sketch.</desc>
  <defs>
    
  </defs>
  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
    <g id="Dribbble-Light-Preview" transform="translate(-140.000000, -2159.000000)" fill="#000000">
      <g id="icons" transform="translate(56.000000, 160.000000)">
        <path d="M100.562548,2016.99998 L87.4381713,2016.99998 C86.7317804,2016.99998 86.2101535,2016.30298 86.4765813,2015.66198 C87.7127655,2012.69798 90.6169306,2010.99998 93.9998492,2010.99998 C97.3837885,2010.99998 100.287954,2012.69798 101.524138,2015.66198 C101.790566,2016.30298 101.268939,2016.99998 100.562548,2016.99998 M89.9166645,2004.99998 C89.9166645,2002.79398 91.7489936,2000.99998 93.9998492,2000.99998 C96.2517256,2000.99998 98.0830339,2002.79398 98.0830339,2004.99998 C98.0830339,2007.20598 96.2517256,2008.99998 93.9998492,2008.99998 C91.7489936,2008.99998 89.9166645,2007.20598 89.9166645,2004.99998 M103.955674,2016.63598 C103.213556,2013.27698 100.892265,2010.79798 97.837022,2009.67298 C99.4560048,2008.39598 100.400241,2006.33098 100.053171,2004.06998 C99.6509769,2001.44698 97.4235996,1999.34798 94.7348224,1999.04198 C91.0232075,1998.61898 87.8750721,2001.44898 87.8750721,2004.99998 C87.8750721,2006.88998 88.7692896,2008.57398 90.1636971,2009.67298 C87.1074334,2010.79798 84.7871636,2013.27698 84.044024,2016.63598 C83.7745338,2017.85698 84.7789973,2018.99998 86.0539717,2018.99998 L101.945727,2018.99998 C103.221722,2018.99998 104.226185,2017.85698 103.955674,2016.63598" id="profile_round-[#1342]">
          
        </path>
      </g>
    </g>
  </g>
</svg></button>
  <button onclick="location.href='user.html'">
    <?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M13 20V18C13 15.2386 10.7614 13 8 13C5.23858 13 3 15.2386 3 18V20H13ZM13 20H21V19C21 16.0545 18.7614 14 16 14C14.5867 14 13.3103 14.6255 12.4009 15.6311M11 7C11 8.65685 9.65685 10 8 10C6.34315 10 5 8.65685 5 7C5 5.34315 6.34315 4 8 4C9.65685 4 11 5.34315 11 7ZM18 9C18 10.1046 17.1046 11 16 11C14.8954 11 14 10.1046 14 9C14 7.89543 14.8954 7 16 7C17.1046 7 18 7.89543 18 9Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
</svg>
  </button>
  <button id="notificationBtn" onclick="location.href='notification.html'">
    <?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="40px" height="40px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M6.31317 12.463C6.20006 9.29213 8.60976 6.6252 11.701 6.5C14.7923 6.6252 17.202 9.29213 17.0889 12.463C17.0889 13.78 18.4841 15.063 18.525 16.383C18.525 16.4017 18.525 16.4203 18.525 16.439C18.5552 17.2847 17.9124 17.9959 17.0879 18.029H13.9757C13.9786 18.677 13.7404 19.3018 13.3098 19.776C12.8957 20.2372 12.3123 20.4996 11.701 20.4996C11.0897 20.4996 10.5064 20.2372 10.0923 19.776C9.66161 19.3018 9.42346 18.677 9.42635 18.029H6.31317C5.48869 17.9959 4.84583 17.2847 4.87602 16.439C4.87602 16.4203 4.87602 16.4017 4.87602 16.383C4.91795 15.067 6.31317 13.781 6.31317 12.463Z" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
  <path d="M9.42633 17.279C9.01212 17.279 8.67633 17.6148 8.67633 18.029C8.67633 18.4432 9.01212 18.779 9.42633 18.779V17.279ZM13.9757 18.779C14.3899 18.779 14.7257 18.4432 14.7257 18.029C14.7257 17.6148 14.3899 17.279 13.9757 17.279V18.779ZM12.676 5.25C13.0902 5.25 13.426 4.91421 13.426 4.5C13.426 4.08579 13.0902 3.75 12.676 3.75V5.25ZM10.726 3.75C10.3118 3.75 9.97601 4.08579 9.97601 4.5C9.97601 4.91421 10.3118 5.25 10.726 5.25V3.75ZM9.42633 18.779H13.9757V17.279H9.42633V18.779ZM12.676 3.75H10.726V5.25H12.676V3.75Z" fill="#000000" />
</svg>
    <span id="notifDot"></span>
  </button>
  
  <button onclick="location.href='msglist.html'">
    <?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22Z" stroke="#1C274C" stroke-width="1.5"/>
<path opacity="0.5" d="M8 12H8.009M11.991 12H12M15.991 12H16" stroke="#1C274C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
  </button>

</div>

<div id="feed">
  <h2>Posts</h2>
  <div id="postsContainer"></div>
  <div id="loadMore" class="load-more">Scroll to load more…</div>
</div>

<div class="floating-post" id="floatingPost" title="Create post">+</div>

<script type="module">
/* ===== Firebase & imports ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

import {
  getFirestore, collection, query, orderBy, limit, startAfter,
  getDocs, doc, onSnapshot, deleteDoc, setDoc, getDoc, addDoc,
  updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.appspot.com",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== State & DOM ===== */
let currentUser = null;
onAuthStateChanged(auth, user => currentUser = user);

if (!localStorage.getItem("deviceID")) {
  localStorage.setItem("deviceID", "dev-" + crypto.randomUUID());
}
const deviceID = localStorage.getItem("deviceID");

const postsContainer = document.getElementById('postsContainer');
const loadMoreEl = document.getElementById('loadMore');
const floatingPost = document.getElementById('floatingPost');
const notifDot = document.getElementById("notifDot");

floatingPost.addEventListener('click', ()=>location.href='post.html');

/* ===== Notification red dot (friend requests & unread chats & notifications) ===== */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  const uid = user.uid;

  // Watch notifications collection for unseen notifications to this user
  const notifQ = query(collection(db,"notifications"), orderBy("createdAt","desc"));
  onSnapshot(notifQ, snap=>{
    const hasNew = snap.docs.some(d=>{
      const dt = d.data();
      return dt.to === uid && !dt.seen;
    });
    notifDot.style.display = hasNew ? "inline-block" : "none";
  });

  // Friend requests
  onSnapshot(collection(db, "friendRequests"), snap => {
    const hasNewReq = snap.docs.some(doc => {
      const data = doc.data();
      return data.to === uid && !data.seen;
    });
    if (hasNewReq) notifDot.style.display = "inline-block";
  });

  // Unread chats (light check)
  const followingRef = collection(db, "users", uid, "following");
  onSnapshot(followingRef, async snap => {
    let hasUnread = false;
    for (const docSnap of snap.docs) {
      const friendUid = docSnap.id;
      const chatId = [uid, friendUid].sort().join("_");
      const messagesRef = collection(db, "chats", chatId, "messages");
      const msgsSnap = await getDocs(messagesRef);
      if (msgsSnap.docs.some(m => m.data().uid !== uid && !(m.data().readBy?.includes(uid)))) {
        hasUnread = true;
        break;
      }
    }
    if (hasUnread) notifDot.style.display = "inline-block";
  });
});

/* ===== Helpers ===== */
const PAGE_SIZE = 6;
let lastVisible = null;
let loading = false;
let finished = false;

const escapeHtml = s => s?.replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])) ?? '';
const formatTime = ts => { try { return ts?.toDate().toLocaleString() || "Just now" } catch { return "Just now" } };

async function getUserProfile(uid){
  if(!uid) return null;
  const userDoc = await getDoc(doc(db,'users',uid));
  return userDoc.exists() ? userDoc.data() : null;
}

/* ===== Render post card (with tags and shared post support) ===== */
async function renderPostCard(postId, data){
  const card = document.createElement('div');
  card.className = 'post-card';
  card.id = `post-${postId}`;

  // If shared post - fetch original
  let sharedData = null;
  if(data.sharedFrom){
    const sDoc = await getDoc(doc(db,'posts',data.sharedFrom));
    if(sDoc.exists()) sharedData = { id: sDoc.id, ...sDoc.data() };
  }

  const profile = await getUserProfile(data.uid);
  const displayName = profile?.fullName || profile?.displayName || data.name || 'Unknown';
  const photoURL = profile?.photoURL || '';

  // build tagged user placeholders (actual names loaded later)
  const tagsHtml = (data.tags?.length) ? `<div class="small-muted">Tagged: ${data.tags.map(uid=>`<span class="taggedUser" data-uid="${uid}">@user</span>`).join(" ")}</div>` : "";

  // Post text (show own text and optionally shared content)
  const ownText = data.text ? `<div class="post-text">${escapeHtml(data.text)}</div>` : "";
  const sharedHtml = sharedData ? `
    <div class="shared-box">
      <div style="font-size:13px;color:#444">Shared post:</div>
      <div style="font-weight:600;margin-top:6px">${escapeHtml(sharedData.text || "")}</div>
      ${sharedData.mediaUrls?.length ? `<div class="post-images" id="shared-media-${postId}"></div>` : ""}
      <div class="small-muted">— by ${await (getUserProfile(sharedData.uid)).then(p=>p?.fullName||p?.displayName||'Unknown')}</div>
    </div>
  ` : "";

  card.innerHTML = `
    <div class="post-header">
      <div class="avatar" style="${photoURL ? 'background-image:url('+photoURL+');background-size:cover;background-position:center' : ''}">
        ${photoURL ? '' : (displayName[0] || 'U').toUpperCase()}
      </div>
      <div style="flex:1">
        <div class="post-name" data-uid="${data.uid}">${displayName}</div>
        <div class="post-time">${formatTime(data.createdAt)}</div>
      </div>
      ${currentUser?.uid !== data.uid ? `<button class="follow-btn" id="follow-${postId}">Follow</button>` : ""}
    </div>

    ${ownText}
    ${tagsHtml}
    ${sharedHtml}

    <div class="post-images" id="img-${postId}"></div>

    <div class="actions">
      <button class="btn like-btn" id="like-${postId}">
      <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 width="25px" height="25px" viewBox="0 0 544.582 544.582"
	 xml:space="preserve">
<g>
	<path d="M448.069,57.839c-72.675-23.562-150.781,15.759-175.721,87.898C247.41,73.522,169.303,34.277,96.628,57.839
		C23.111,81.784-16.975,160.885,6.894,234.708c22.95,70.38,235.773,258.876,263.006,258.876
		c27.234,0,244.801-188.267,267.751-258.876C561.595,160.732,521.509,81.631,448.069,57.839z"/>
</g>
</svg>
      
      </button>
      <span class="likes-count" id="likes-${postId}">0</span>

      <button class="btn comment-btn" id="toggle-${postId}">
      <?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="30px" height="30px" viewBox="0 -0.5 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M5.5 12C5.49988 14.613 6.95512 17.0085 9.2741 18.2127C11.5931 19.4169 14.3897 19.2292 16.527 17.726L19.5 18V12C19.5 8.13401 16.366 5 12.5 5C8.63401 5 5.5 8.13401 5.5 12Z" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
  <path d="M9.5 13.25C9.08579 13.25 8.75 13.5858 8.75 14C8.75 14.4142 9.08579 14.75 9.5 14.75V13.25ZM13.5 14.75C13.9142 14.75 14.25 14.4142 14.25 14C14.25 13.5858 13.9142 13.25 13.5 13.25V14.75ZM9.5 10.25C9.08579 10.25 8.75 10.5858 8.75 11C8.75 11.4142 9.08579 11.75 9.5 11.75V10.25ZM15.5 11.75C15.9142 11.75 16.25 11.4142 16.25 11C16.25 10.5858 15.9142 10.25 15.5 10.25V11.75ZM9.5 14.75H13.5V13.25H9.5V14.75ZM9.5 11.75H15.5V10.25H9.5V11.75Z" fill="#000000" />
</svg>
      
      </button>

      <button class="btn share-btn" id="share-${postId}">
      <?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg widbutt25px" height="25px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M9.61109 12.4L10.8183 18.5355C11.0462 19.6939 12.6026 19.9244 13.1565 18.8818L19.0211 7.84263C19.248 7.41555 19.2006 6.94354 18.9737 6.58417M9.61109 12.4L5.22642 8.15534C4.41653 7.37131 4.97155 6 6.09877 6H17.9135C18.3758 6 18.7568 6.24061 18.9737 6.58417M9.61109 12.4L18.9737 6.58417M19.0555 6.53333L18.9737 6.58417" stroke="#000000" stroke-width="2" />
</svg>
      </button>

      <span class="views-count" id="views-${postId}">0 views</span>

      ${currentUser?.uid === data.uid ? `<button class="btn delete-btn" id="del-${postId}">
      <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="25px" height="25px" viewBox="0 -0.5 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">

  <title>delete [#1487]</title>
  <desc>Created with Sketch.</desc>
  <defs>
    
  </defs>
  <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
    <g id="Dribbble-Light-Preview" transform="translate(-179.000000, -360.000000)" fill="#000000">
      <g id="icons" transform="translate(56.000000, 160.000000)">
        <path d="M130.35,216 L132.45,216 L132.45,208 L130.35,208 L130.35,216 Z M134.55,216 L136.65,216 L136.65,208 L134.55,208 L134.55,216 Z M128.25,218 L138.75,218 L138.75,206 L128.25,206 L128.25,218 Z M130.35,204 L136.65,204 L136.65,202 L130.35,202 L130.35,204 Z M138.75,204 L138.75,200 L128.25,200 L128.25,204 L123,204 L123,206 L126.15,206 L126.15,220 L140.85,220 L140.85,206 L144,206 L144,204 L138.75,204 Z" id="delete-[#1487]">
          
        </path>
      </g>
    </g>
  </g>
</svg>
      </button>` : ""}
    </div>

    <div class="comments-area" id="carea-${postId}" style="display:none">
      <textarea id="cinput-${postId}" class="comment-input" placeholder="Write a comment…"></textarea>
      <button class="btn comment-btn" id="cpost-${postId}">
      <?xml version="1.0" encoding="utf-8"?><!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M20.7639 12H10.0556M3 8.00003H5.5M4 12H5.5M4.5 16H5.5M9.96153 12.4896L9.07002 15.4486C8.73252 16.5688 8.56376 17.1289 8.70734 17.4633C8.83199 17.7537 9.08656 17.9681 9.39391 18.0415C9.74792 18.1261 10.2711 17.8645 11.3175 17.3413L19.1378 13.4311C20.059 12.9705 20.5197 12.7402 20.6675 12.4285C20.7961 12.1573 20.7961 11.8427 20.6675 11.5715C20.5197 11.2598 20.059 11.0295 19.1378 10.5689L11.3068 6.65342C10.2633 6.13168 9.74156 5.87081 9.38789 5.95502C9.0808 6.02815 8.82627 6.24198 8.70128 6.53184C8.55731 6.86569 8.72427 7.42461 9.05819 8.54246L9.96261 11.5701C10.0137 11.7411 10.0392 11.8266 10.0493 11.9137C10.0583 11.991 10.0582 12.069 10.049 12.1463C10.0387 12.2334 10.013 12.3188 9.96153 12.4896Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
      
      </button>
      <div id="clist-${postId}" class="clist"></div>
    </div>
  `;

  // append shared media if present
  if(sharedData?.mediaUrls?.length){
    const sharedMediaBox = card.querySelector(`#shared-media-${postId}`);
    sharedData.mediaUrls.forEach(url=>{
      if(url.match(/\.(mp4|webm|ogg)$/)){
        const vid = document.createElement('video'); vid.src=url; vid.controls=true;
        vid.style.maxWidth = sharedData.mediaUrls.length===1 ? '100%' : '48%';
        sharedMediaBox.appendChild(vid);
      } else {
        const img = document.createElement('img'); img.src=url;
        img.style.maxWidth = sharedData.mediaUrls.length===1 ? '100%' : '48%';
        sharedMediaBox.appendChild(img);
      }
    });
  }

  // append own media
  const imgBox = card.querySelector(`#img-${postId}`);
  if(data.mediaUrls?.length){
    data.mediaUrls.forEach(url=>{
      if(url.match(/\.(mp4|webm|ogg)$/)){
        const video = document.createElement('video');
        video.src = url; video.controls = true;
        video.style.maxWidth = data.mediaUrls.length===1?'100%':'48%';
        imgBox.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = data.mediaUrls.length===1?'100%':'48%';
        imgBox.appendChild(img);
      }
    });
  }

  // Name click
  card.querySelector('.post-name').onclick = e=>{
    const uid = e.target.dataset.uid;
    location.href = `profile.html?uid=${uid}`;
  };

  // Populate tag names (replace @user placeholders)
  if(data.tags?.length){
    data.tags.forEach(async (uid) => {
      const el = card.querySelector(`.taggedUser[data-uid="${uid}"]`);
      if(el){
        const p = await getUserProfile(uid);
        el.textContent = '@' + (p?.fullName || p?.displayName || 'user');
        el.onclick = ()=> location.href = `profile.html?uid=${uid}`;
      }
    });
  }

  // LIKE system
  const likeBtn = card.querySelector(`#like-${postId}`);
  likeBtn.onclick = async ()=>{
    if(!currentUser) return alert('Login first');
    await setDoc(doc(db,'posts',postId,'likes',currentUser.uid),{likedAt:new Date()});
  };
  onSnapshot(collection(db,'posts',postId,'likes'), snap=>{
    card.querySelector(`#likes-${postId}`).textContent = snap.size;
  });

  // DELETE
  const delBtn = card.querySelector(`#del-${postId}`);
  if(delBtn){
    delBtn.onclick = async ()=>{
      if(!confirm('Delete this post?')) return;
      await deleteDoc(doc(db,'posts',postId));
      card.remove();
    };
  }

  // FOLLOW button
  const fbtn = card.querySelector(`#follow-${postId}`);
  if(fbtn){
    fbtn.onclick = async ()=>{
      if(!currentUser) return alert('Login');
      const follower = doc(db,'users',data.uid,'followers',currentUser.uid);
      const following = doc(db,'users',currentUser.uid,'following',data.uid);
      const snap = await getDoc(follower);
      if(snap.exists()){ 
        await deleteDoc(follower); 
        await deleteDoc(following); 
        fbtn.textContent='Follow'; 
      } else { 
        await setDoc(follower,{followedAt:new Date()});
        await setDoc(following,{followedAt:new Date()});
        fbtn.textContent='Following'; 
      }
    };
    getDoc(doc(db,'users',data.uid,'followers',currentUser?.uid))
      .then(s=>fbtn.textContent = s.exists()?'Following':'Follow');
  }

  // COMMENTS
  const carea = card.querySelector(`#carea-${postId}`);
  card.querySelector(`#toggle-${postId}`).onclick = ()=>carea.style.display =
    carea.style.display==='none' ? 'block':'none';

  const list = card.querySelector(`#clist-${postId}`);
  onSnapshot(collection(db,'posts',postId,'comments'),snap=>{
    list.innerHTML='';
    snap.forEach(c=>{
      const d = c.data();
      const div = document.createElement('div');
      div.className='comment-card';
      div.innerHTML=`
        <div style="font-weight:700">${escapeHtml(d.name||d.uid)}</div>
        <div style="font-size:12px;color:#666">${formatTime(d.createdAt)}</div>
        <div>${escapeHtml(d.text)}</div>`;
      list.appendChild(div);
    });
  });

  card.querySelector(`#cpost-${postId}`).onclick = async ()=>{
    if(!currentUser) return alert('Login first');
    const txt = card.querySelector(`#cinput-${postId}`).value.trim();
    if(!txt) return;
    await addDoc(collection(db,'posts',postId,'comments'),{
      uid:currentUser.uid,
      name:currentUser.displayName||currentUser.email||'Unknown',
      text:txt,
      createdAt:new Date()
    });
    card.querySelector(`#cinput-${postId}`).value='';
  };

  // SHARE
  const shareBtn = card.querySelector(`#share-${postId}`);
  shareBtn.onclick = async ()=>{
    if(!currentUser) return alert("Login first");
    // create a lightweight shared post that references sharedFrom
    await addDoc(collection(db,'posts'),{
      uid: currentUser.uid,
      name: currentUser.displayName || currentUser.email,
      text: '',
      createdAt: serverTimestamp(),
      mediaUrls: [],
      sharedFrom: postId
    });
    alert("Post shared!");
  };

  // VIEW COUNTER
  const viewDocId = currentUser?.uid || deviceID;
  if (!sessionStorage.getItem("viewed-" + postId)) {
    sessionStorage.setItem("viewed-" + postId, "true");
    await setDoc(doc(db, "posts", postId, "views", viewDocId), {
      viewedAt: new Date()
    });
  }
  onSnapshot(collection(db, "posts", postId, "views"), snap => {
    card.querySelector(`#views-${postId}`).textContent = snap.size + " views";
  });

  postsContainer.appendChild(card);
}

/* ===== Load posts with pagination ===== */
async function loadPosts(initial=false){
  if(loading || finished) return;
  loading = true;

  let q = query(collection(db,'posts'),orderBy('createdAt','desc'),limit(PAGE_SIZE));
  if(!initial && lastVisible) 
    q = query(collection(db,'posts'),orderBy('createdAt','desc'),
      startAfter(lastVisible),limit(PAGE_SIZE));

  const snap = await getDocs(q);
  if(snap.empty){
    finished = true;
    loadMoreEl.textContent = initial?'No posts yet':'No more posts';
    loading=false;
    return;
  }

  lastVisible = snap.docs[snap.docs.length-1];
  snap.docs.forEach(d=>renderPostCard(d.id,d.data()));
  loading=false;
}

/* ===== Infinite scroll ===== */
window.addEventListener('scroll',()=>{
  if((window.innerHeight + window.scrollY) >= document.body.offsetHeight-120){
    loadPosts();
  }
});

/* ===== Initial load ===== */
loadPosts(true);

</script>
</body>
	</html>
