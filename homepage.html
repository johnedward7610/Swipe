<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Homepage</title>
<style>
:root{--primary:#606CF9;--accent:#ff6e6e}
body{font-family:sans-serif;background:#f4f6ff;margin:0;padding:20px;}
.hotbar{display:flex;gap:10px;margin-bottom:14px}
.hotbar button{padding:10px 16px;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer;position:relative}
#feed{max-width:900px;margin:0 auto}
.post-card{background:#fff;padding:16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-bottom:16px}
.post-header{display:flex;align-items:center;gap:12px}
.avatar{width:48px;height:48px;border-radius:999px;background:linear-gradient(135deg,#cfe1ff,#e7dfff);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;overflow:hidden}
.post-name{font-weight:700;cursor:pointer}
.post-time{color:#777;font-size:12px}
.post-text{margin:12px 0;white-space:pre-wrap}
.post-images{display:flex;gap:8px;overflow:hidden;flex-wrap:wrap}
.post-images img, .post-images video{max-height:220px;border-radius:10px;object-fit:cover;cursor:pointer}
.actions{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
.like-btn{background:var(--accent);color:#fff}
.comment-btn{background:var(--primary);color:#fff}
.delete-btn{background:#222;color:#fff}
.share-btn{background:#888;color:#fff}
.likes-count{font-weight:700;margin-left:6px}
.views-count{color:#555;font-size:14px;margin-left:auto}
.comments-area{margin-top:10px;border-top:1px solid #eee;padding-top:10px}
.comment-card{background:#f6f7ff;padding:8px;border-radius:8px;margin-bottom:8px}
.floating-post{position:fixed;right:22px;bottom:22px;width:58px;height:58px;border-radius:999px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-size:32px;box-shadow:0 8px 24px rgba(0,0,0,.15);cursor:pointer}
.load-more{padding:12px;text-align:center;color:#555}
.follow-btn{padding:6px 10px;border-radius:8px;border:none;background:#fff;color:var(--primary);cursor:pointer}
textarea.comment-input{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:6px;resize:none}
.taggedUser{color:var(--primary);font-weight:700;cursor:pointer;margin-right:6px}
.shared-box{margin-top:10px;padding:10px;background:#f0f2ff;border-radius:10px}
.small-muted{font-size:13px;color:#666;margin-top:6px}
/* RED DOT FOR NOTIFICATIONS */
#notifDot {
  position: absolute;
  top:5px;
  right:5px;
  width:10px;
  height:10px;
  background:red;
  border-radius:50%;
  display:none;
}

/* Viewer styles */
#videoViewer {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.98);
  display:none;
  z-index:9999999;
  overflow:hidden;
  touch-action:none;
}
#viewerContent { position:absolute; inset:0; display:flex; justify-content:center; align-items:center; }
.viewerImage, #viewerVideo { max-width:100%; max-height:100%; object-fit:contain; border-radius:6px; background:black; }
#viewerVideo { display:block; width:100%; height:100%; }
#viewerTopControls { position:absolute; top:18px; right:18px; z-index:40; display:flex; gap:10px; align-items:center; }
.viewerBtn { background:rgba(0,0,0,0.45); border:none; color:white; padding:8px 10px; border-radius:8px; font-size:18px; cursor:pointer; }

/* Indicator */
#viewerIndicator { position:absolute; top:18px; left:18px; color:#fff; font-size:14px; z-index:40; background:rgba(0,0,0,0.35); padding:6px 8px; border-radius:8px; }

/* hide the native outline for video on mobile */
video::-webkit-media-controls { display:none !important; }

/* preview active press */
.post-images img, .post-images video { transition: transform .12s ease; }
.post-images img:active, .post-images video:active { transform: scale(.98); }
</style>
</head>
<body>

<div class="hotbar">
  <button onclick="location.href='profile.html'">
    <!-- profile icon -->
    <svg width="25px" height="25px" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM2 18a8 8 0 1 1 16 0H2z" fill="#fff" opacity="0.9"/></svg>
  </button>

  <button onclick="location.href='user.html'">
    <!-- users -->
    <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 20V18C13 15.2386 10.7614 13 8 13C5.23858 13 3 15.2386 3 18V20H13ZM13 20H21V19C21 16.0545 18.7614 14 16 14" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <button id="notificationBtn" onclick="location.href='notification.html'">
    <!-- bell -->
    <svg width="40px" height="40px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12a6 6 0 0 1 12 0v4h2v2H4v-2h2v-4z" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span id="notifDot"></span>
  </button>

  <button onclick="location.href='msglist.html'">
    <!-- messages -->
    <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>
</div>

<div id="feed">
  <h2>Posts</h2>
  <div id="postsContainer"></div>
  <div id="loadMore" class="load-more">Scroll to load moreâ€¦</div>
</div>

<div class="floating-post" id="floatingPost" title="Create post">+</div>

<!-- ===== Mixed-media Fullscreen Viewer (images + videos) ===== -->
<div id="videoViewer" aria-hidden="true">
  <div id="viewerTopControls">
    <button id="closeViewer" class="viewerBtn" title="Close">âœ•</button>
    <button id="soundToggle" class="viewerBtn" title="Toggle sound">ðŸ”‡</button>
  </div>
  <div id="viewerIndicator" aria-hidden="true">0 / 0</div>

  <div id="viewerContent">
    <!-- we will insert either an <img class="viewerImage"> or <video id="viewerVideo"> -->
  </div>

  <!-- swipe layer sits above viewer content to capture gestures -->
  <div id="swipeLayer" style="position:absolute; inset:0; z-index:30;"></div>
</div>

<script type="module">
/* ===== Firebase & imports ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

import {
  getFirestore, collection, query, orderBy, limit, startAfter,
  getDocs, doc, onSnapshot, deleteDoc, setDoc, getDoc, addDoc,
  updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.appspot.com",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== State & DOM ===== */
let currentUser = null;
onAuthStateChanged(auth, user => currentUser = user);

if (!localStorage.getItem("deviceID")) {
  localStorage.setItem("deviceID", "dev-" + crypto.randomUUID());
}
const deviceID = localStorage.getItem("deviceID");

const postsContainer = document.getElementById('postsContainer');
const loadMoreEl = document.getElementById('loadMore');
const floatingPost = document.getElementById('floatingPost');
const notifDot = document.getElementById("notifDot");

floatingPost.addEventListener('click', ()=>location.href='post.html');

/* ===== Notification red dot (friend requests & unread chats & notifications) ===== */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  const uid = user.uid;

  // Watch notifications collection for unseen notifications to this user
  const notifQ = query(collection(db,"notifications"), orderBy("createdAt","desc"));
  onSnapshot(notifQ, snap=>{
    const hasNew = snap.docs.some(d=>{
      const dt = d.data();
      return dt.to === uid && !dt.seen;
    });
    notifDot.style.display = hasNew ? "inline-block" : "none";
  });

  // Friend requests
  onSnapshot(collection(db, "friendRequests"), snap => {
    const hasNewReq = snap.docs.some(doc => {
      const data = doc.data();
      return data.to === uid && !data.seen;
    });
    if (hasNewReq) notifDot.style.display = "inline-block";
  });

  // Unread chats (light check)
  const followingRef = collection(db, "users", uid, "following");
  onSnapshot(followingRef, async snap => {
    let hasUnread = false;
    for (const docSnap of snap.docs) {
      const friendUid = docSnap.id;
      const chatId = [uid, friendUid].sort().join("_");
      const messagesRef = collection(db, "chats", chatId, "messages");
      const msgsSnap = await getDocs(messagesRef);
      if (msgsSnap.docs.some(m => m.data().uid !== uid && !(m.data().readBy?.includes(uid)))) {
        hasUnread = true;
        break;
      }
    }
    if (hasUnread) notifDot.style.display = "inline-block";
  });
});

/* ===== Helpers ===== */
const PAGE_SIZE = 6;
let lastVisible = null;
let loading = false;
let finished = false;

const escapeHtml = s => s?.replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])) ?? '';
const formatTime = ts => { try { return ts?.toDate().toLocaleString() || "Just now" } catch { return "Just now" } };

async function getUserProfile(uid){
  if(!uid) return null;
  const userDoc = await getDoc(doc(db,'users',uid));
  return userDoc.exists() ? userDoc.data() : null;
}

/* ===== Mixed-media feed state (images & videos) =====
   feedItems is an array of items we can view in the fullscreen viewer.
   Each item: { type: "video"|"image", url: string, postId: string }
*/
let feedItems = [];
let viewerIndex = 0;

/* Viewer DOM refs */
const viewer = document.getElementById('videoViewer');
const viewerContent = document.getElementById('viewerContent');
const swipeLayer = document.getElementById('swipeLayer');
const closeViewerBtn = document.getElementById('closeViewer');
const soundToggleBtn = document.getElementById('soundToggle');
const viewerIndicator = document.getElementById('viewerIndicator');

function updateIndicator() {
  viewerIndicator.textContent = `${viewerIndex + 1} / ${feedItems.length}`;
}

/* Open viewer on an item index */
function openViewer(index){
  if(index < 0 || index >= feedItems.length) return;
  viewerIndex = index;
  renderViewerItem();
  viewer.style.display = 'block';
  document.body.style.overflow = 'hidden'; // disable background scroll
  viewer.setAttribute('aria-hidden','false');
}

/* Close viewer */
function closeViewer(){
  // remove content and pause any playing video
  const vid = viewerContent.querySelector('video');
  if(vid){ try{ vid.pause(); } catch(e){} }
  viewerContent.innerHTML = '';
  viewer.style.display = 'none';
  document.body.style.overflow = ''; // restore scroll
  viewer.setAttribute('aria-hidden','true');
}

/* Render current item inside viewerContent */
function renderViewerItem(){
  viewerContent.innerHTML = '';
  if(!feedItems.length) return;
  const it = feedItems[viewerIndex];
  updateIndicator();

  if(it.type === 'image'){
    const img = document.createElement('img');
    img.src = it.url;
    img.className = 'viewerImage';
    img.alt = '';
    img.style.maxWidth = '95%';
    img.style.maxHeight = '95%';
    viewerContent.appendChild(img);
    soundToggleBtn.style.display = 'none';
  } else {
    // video
    const video = document.createElement('video');
    video.src = it.url;
    video.id = 'viewerVideo';
    video.className = 'viewerVideo';
    video.autoplay = true;
    video.playsInline = true;
    video.controls = false;
    video.muted = false; // start unmuted once user opened viewer (tap counted)
    video.style.maxWidth = '95%';
    video.style.maxHeight = '95%';
    viewerContent.appendChild(video);
    soundToggleBtn.style.display = 'inline-block';
    soundToggleBtn.textContent = video.muted ? 'ðŸ”‡' : 'ðŸ”Š';

    // click to toggle play/pause
    video.addEventListener('click', () => {
      if(video.paused) video.play().catch(()=>{});
      else video.pause();
    });

    // preload next video URL (for smoother transitions)
    const next = feedItems[viewerIndex + 1];
    if(next && next.type === 'video') {
      const p = document.createElement('link');
      p.rel = 'preload';
      p.as = 'video';
      p.href = next.url;
      document.head.appendChild(p);
      // cleanup after short delay
      setTimeout(()=>{ try{ document.head.removeChild(p); } catch(e){} }, 5000);
    }
  }
}

/* Move to next or previous */
function goToNext(){
  if(viewerIndex < feedItems.length - 1){
    viewerIndex++;
    renderViewerItem();
  }
}
function goToPrev(){
  if(viewerIndex > 0){
    viewerIndex--;
    renderViewerItem();
  }
}

/* Controls */
closeViewerBtn.onclick = closeViewer;
soundToggleBtn.onclick = () => {
  const vid = viewerContent.querySelector('video');
  if(!vid) return;
  vid.muted = !vid.muted;
  soundToggleBtn.textContent = vid.muted ? 'ðŸ”‡' : 'ðŸ”Š';
};

/* Keyboard navigation */
document.addEventListener('keydown', (e) => {
  if(viewer.style.display !== 'block') return;
  if(e.key === 'Escape') return closeViewer();
  if(e.key === 'ArrowDown' || e.key === 'ArrowRight') return goToNext();
  if(e.key === 'ArrowUp' || e.key === 'ArrowLeft') return goToPrev();
});

/* Swipe detection on swipeLayer */
let startY = 0, lastY = 0;
swipeLayer.addEventListener('touchstart', (e)=>{ startY = e.touches[0].clientY; lastY = startY; }, {passive:true});
swipeLayer.addEventListener('touchmove', (e)=>{ lastY = e.touches[0].clientY; }, {passive:true});
swipeLayer.addEventListener('touchend', (e)=>{
  const diff = startY - lastY;
  if(Math.abs(diff) < 50) return;
  if(diff > 50) goToNext();
  else goToPrev();
}, {passive:true});

/* also capture mouse wheel for desktops when viewer open (vertical wheel -> next/prev) */
let wheelTimeout = null;
swipeLayer.addEventListener('wheel', (e)=>{
  if(viewer.style.display !== 'block') return;
  if(Math.abs(e.deltaY) < 30) return;
  if(e.deltaY > 0) goToNext();
  else goToPrev();
  // throttle
  clearTimeout(wheelTimeout);
  wheelTimeout = setTimeout(()=>{}, 200);
});

/* Clicking outside content closes viewer */
viewer.addEventListener('click', (e)=>{
  // if click target is viewer (background) or swipeLayer, close
  if(e.target.id === 'videoViewer' || e.target.id === 'swipeLayer') closeViewer();
});

/* ===== Render post card (with tags and shared post support) ===== */
async function renderPostCard(postId, data){
  const card = document.createElement('div');
  card.className = 'post-card';
  card.id = `post-${postId}`;

  // If shared post - fetch original
  let sharedData = null;
  if(data.sharedFrom){
    const sDoc = await getDoc(doc(db,'posts',data.sharedFrom));
    if(sDoc.exists()) sharedData = { id: sDoc.id, ...sDoc.data() };
  }

  const profile = await getUserProfile(data.uid);
  const displayName = profile?.fullName || profile?.displayName || data.name || 'Unknown';
  const photoURL = profile?.photoURL || '';

  const tagsHtml = (data.tags?.length) ? `<div class="small-muted">Tagged: ${data.tags.map(uid=>`<span class="taggedUser" data-uid="${uid}">@user</span>`).join(" ")}</div>` : "";
  const ownText = data.text ? `<div class="post-text">${escapeHtml(data.text)}</div>` : "";
  const sharedHtml = sharedData ? `
    <div class="shared-box">
      <div style="font-size:13px;color:#444">Shared post:</div>
      <div style="font-weight:600;margin-top:6px">${escapeHtml(sharedData.text || "")}</div>
      ${sharedData.mediaUrls?.length ? `<div class="post-images" id="shared-media-${postId}"></div>` : ""}
      <div class="small-muted">â€” by ${await (getUserProfile(sharedData.uid)).then(p=>p?.fullName||p?.displayName||'Unknown')}</div>
    </div>
  ` : "";

  card.innerHTML = `
    <div class="post-header">
      <div class="avatar" style="${photoURL ? 'background-image:url('+photoURL+');background-size:cover;background-position:center' : ''}">
        ${photoURL ? '' : (displayName[0] || 'U').toUpperCase()}
      </div>
      <div style="flex:1">
        <div class="post-name" data-uid="${data.uid}">${displayName}</div>
        <div class="post-time">${formatTime(data.createdAt)}</div>
      </div>
      ${currentUser?.uid !== data.uid ? `<button class="follow-btn" id="follow-${postId}">Follow</button>` : ""}
    </div>

    ${ownText}
    ${tagsHtml}
    ${sharedHtml}

    <div class="post-images" id="img-${postId}"></div>

    <div class="actions">
      <button class="btn like-btn" id="like-${postId}">
        <svg fill="#000000" width="25" height="25" viewBox="0 0 24 24"><path d="M12 21s-7-4.35-9-7c-2.1-2.9-1.1-6 1.6-7.4C7.1 6 8.7 6 10 7.4L12 9l2-1.6c1.3-1.4 2.9-1.4 5.4-0.8 2.6 1.4 3.6 4.5 1.6 7.4-2 2.7-9 7-9 7z"/></svg>
      </button>
      <span class="likes-count" id="likes-${postId}">0</span>

      <button class="btn comment-btn" id="toggle-${postId}">
        <!-- comment icon -->
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10z" stroke="#fff" stroke-width="0" /></svg>
      </button>

      <button class="btn share-btn" id="share-${postId}">Share</button>

      <span class="views-count" id="views-${postId}">0 views</span>

      ${currentUser?.uid === data.uid ? `<button class="btn delete-btn" id="del-${postId}">Delete</button>` : ""}
    </div>

    <div class="comments-area" id="carea-${postId}" style="display:none">
      <textarea id="cinput-${postId}" class="comment-input" placeholder="Write a commentâ€¦"></textarea>
      <button class="btn comment-btn" id="cpost-${postId}">Post</button>
      <div id="clist-${postId}" class="clist"></div>
    </div>
  `;

  // append shared media if present
  if(sharedData?.mediaUrls?.length){
    const sharedMediaBox = card.querySelector(`#shared-media-${postId}`);
    sharedData.mediaUrls.forEach(url=>{
      if(url.match(/\.(mp4|webm|ogg)$/)){
        const vid = document.createElement('video'); vid.src=url; vid.controls=true;
        vid.style.maxWidth = sharedData.mediaUrls.length===1 ? '100%' : '48%';
        sharedMediaBox.appendChild(vid);
      } else {
        const img = document.createElement('img'); img.src=url;
        img.style.maxWidth = sharedData.mediaUrls.length===1 ? '100%' : '48%';
        sharedMediaBox.appendChild(img);
      }
    });
  }

  // append own media (and push into feedItems array for viewer)
  const imgBox = card.querySelector(`#img-${postId}`);
  if(data.mediaUrls?.length){
    data.mediaUrls.forEach(url=>{
      const isVideo = !!url.match(/\.(mp4|webm|ogg)$/i);
      if(isVideo){
        const video = document.createElement('video');
        video.src = url;
        video.controls = false;    // preview no controls
        video.muted = true;        // muted preview
        video.playsInline = true;
        video.style.maxWidth = data.mediaUrls.length===1 ? '100%' : '48%';
        video.style.cursor = 'pointer';
        video.preload = 'metadata';

        // add to viewer feed
        const idx = feedItems.push({type:'video', url, postId}) - 1;

        // clicking opens viewer at that index
        video.addEventListener('click', (e)=>{
          e.stopPropagation();
          openViewer(idx);
        });

        imgBox.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = data.mediaUrls.length===1 ? '100%' : '48%';
        img.style.cursor = 'pointer';

        // add to viewer feed
        const idx = feedItems.push({type:'image', url, postId}) - 1;

        img.addEventListener('click', (e)=>{
          e.stopPropagation();
          openViewer(idx);
        });

        imgBox.appendChild(img);
      }
    });
  }

  // Name click
  card.querySelector('.post-name').onclick = e=>{
    const uid = e.target.dataset.uid;
    location.href = `profile.html?uid=${uid}`;
  };

  // Populate tag names (replace @user placeholders)
  if(data.tags?.length){
    data.tags.forEach(async (uid) => {
      const el = card.querySelector(`.taggedUser[data-uid="${uid}"]`);
      if(el){
        const p = await getUserProfile(uid);
        el.textContent = '@' + (p?.fullName || p?.displayName || 'user');
        el.onclick = ()=> location.href = `profile.html?uid=${uid}`;
      }
    });
  }

  // LIKE system
  const likeBtn = card.querySelector(`#like-${postId}`);
  likeBtn.onclick = async ()=>{
    if(!currentUser) return alert('Login first');
    await setDoc(doc(db,'posts',postId,'likes',currentUser.uid),{likedAt:new Date()});
  };
  onSnapshot(collection(db,'posts',postId,'likes'), snap=>{
    card.querySelector(`#likes-${postId}`).textContent = snap.size;
  });

  // DELETE
  const delBtn = card.querySelector(`#del-${postId}`);
  if(delBtn){
    delBtn.onclick = async ()=>{
      if(!confirm('Delete this post?')) return;
      await deleteDoc(doc(db,'posts',postId));
      card.remove();
    };
  }

  // FOLLOW button
  const fbtn = card.querySelector(`#follow-${postId}`);
  if(fbtn){
    fbtn.onclick = async ()=>{
      if(!currentUser) return alert('Login');
      const follower = doc(db,'users',data.uid,'followers',currentUser.uid);
      const following = doc(db,'users',currentUser.uid,'following',data.uid);
      const snap = await getDoc(follower);
      if(snap.exists()){ 
        await deleteDoc(follower); 
        await deleteDoc(following); 
        fbtn.textContent='Follow'; 
      } else { 
        await setDoc(follower,{followedAt:new Date()});
        await setDoc(following,{followedAt:new Date()});
        fbtn.textContent='Following'; 
      }
    };
    getDoc(doc(db,'users',data.uid,'followers',currentUser?.uid))
      .then(s=>fbtn.textContent = s.exists()?'Following':'Follow');
  }

  // COMMENTS
  const carea = card.querySelector(`#carea-${postId}`);
  card.querySelector(`#toggle-${postId}`).onclick = ()=>carea.style.display =
    carea.style.display==='none' ? 'block':'none';

  const list = card.querySelector(`#clist-${postId}`);
  onSnapshot(collection(db,'posts',postId,'comments'),snap=>{
    list.innerHTML='';
    snap.forEach(c=>{
      const d = c.data();
      const div = document.createElement('div');
      div.className='comment-card';
      div.innerHTML=`
        <div style="font-weight:700">${escapeHtml(d.name||d.uid)}</div>
        <div style="font-size:12px;color:#666">${formatTime(d.createdAt)}</div>
        <div>${escapeHtml(d.text)}</div>`;
      list.appendChild(div);
    });
  });

  card.querySelector(`#cpost-${postId}`).onclick = async ()=>{
    if(!currentUser) return alert('Login first');
    const txt = card.querySelector(`#cinput-${postId}`).value.trim();
    if(!txt) return;
    await addDoc(collection(db,'posts',postId,'comments'),{
      uid:currentUser.uid,
      name:currentUser.displayName||currentUser.email||'Unknown',
      text:txt,
      createdAt:new Date()
    });
    card.querySelector(`#cinput-${postId}`).value='';
  };

  // SHARE
  const shareBtn = card.querySelector(`#share-${postId}`);
  shareBtn.onclick = async ()=>{
    if(!currentUser) return alert("Login first");
    // create a lightweight shared post that references sharedFrom
    await addDoc(collection(db,'posts'),{
      uid: currentUser.uid,
      name: currentUser.displayName || currentUser.email,
      text: '',
      createdAt: serverTimestamp(),
      mediaUrls: [],
      sharedFrom: postId
    });
    alert("Post shared!");
  };

  // VIEW COUNTER
  const viewDocId = currentUser?.uid || deviceID;
  if (!sessionStorage.getItem("viewed-" + postId)) {
    sessionStorage.setItem("viewed-" + postId, "true");
    await setDoc(doc(db, "posts", postId, "views", viewDocId), {
      viewedAt: new Date()
    });
  }
  onSnapshot(collection(db, "posts", postId, "views"), snap => {
    card.querySelector(`#views-${postId}`).textContent = snap.size + " views";
  });

  postsContainer.appendChild(card);
}

/* ===== Load posts with pagination ===== */
async function loadPosts(initial=false){
  if(loading || finished) return;
  loading = true;

  let q = query(collection(db,'posts'),orderBy('createdAt','desc'),limit(PAGE_SIZE));
  if(!initial && lastVisible) 
    q = query(collection(db,'posts'),orderBy('createdAt','desc'),
      startAfter(lastVisible),limit(PAGE_SIZE));

  const snap = await getDocs(q);
  if(snap.empty){
    finished = true;
    loadMoreEl.textContent = initial?'No posts yet':'No more posts';
    loading=false;
    return;
  }

  lastVisible = snap.docs[snap.docs.length-1];
  snap.docs.forEach(d=>renderPostCard(d.id,d.data()));
  loading=false;
}

/* ===== Infinite scroll ===== */
window.addEventListener('scroll',()=>{
  if((window.innerHeight + window.scrollY) >= document.body.offsetHeight-120){
    loadPosts();
  }
});

/* ===== Initial load ===== */
loadPosts(true);

</script>
</body>
	  </html>
