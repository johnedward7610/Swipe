<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Homepage</title>

<style>
:root{--primary:#6e8ef5;--accent:#ff6e6e}
body{font-family:sans-serif;background:#f4f6ff;margin:0;padding:20px;}
.hotbar{display:flex;gap:10px;margin-bottom:14px}
.hotbar button{padding:10px 16px;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer}
#feed{max-width:800px;margin:0 auto}
.post-card{background:#fff;padding:16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-bottom:16px}
.post-header{display:flex;align-items:center;gap:12px}
.avatar{width:48px;height:48px;border-radius:999px;background:linear-gradient(135deg,#cfe1ff,#e7dfff);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;overflow:hidden}
.post-name{font-weight:700;cursor:pointer}
.post-time{color:#777;font-size:12px}
.post-text{margin:12px 0;white-space:pre-wrap}
.post-images{display:flex;gap:8px;overflow:hidden;flex-wrap:wrap}
.post-images img, .post-images video{max-height:220px;border-radius:10px;object-fit:cover;cursor:pointer}
.actions{margin-top:10px;display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
.like-btn{background:var(--accent);color:#fff}
.comment-btn{background:var(--primary);color:#fff}
.delete-btn{background:#222;color:#fff}
.likes-count{font-weight:700;margin-left:6px}
.views-count{color:#555;font-size:14px;margin-left:auto}
.comments-area{margin-top:10px;border-top:1px solid #eee;padding-top:10px}
.comment-card{background:#f6f7ff;padding:8px;border-radius:8px;margin-bottom:8px}
.floating-post{position:fixed;right:22px;bottom:22px;width:58px;height:58px;border-radius:999px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-size:32px;box-shadow:0 8px 24px rgba(0,0,0,.15);cursor:pointer}
.load-more{padding:12px;text-align:center;color:#555}
.follow-btn{padding:6px 10px;border-radius:8px;border:none;background:#fff;color:var(--primary);cursor:pointer}
textarea.comment-input{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:6px;resize:none}
</style>
</head>
<body>

<div class="hotbar">
  <button onclick="location.href='profile.html'">My Profile</button>
  <button onclick="location.href='user.html'">Users</button>
  <button onclick="location.href='post.html'">Create Post</button>
  <button onclick="location.href='notification.html'">notification</button>
</div>

<div id="feed">
  <h2>Posts</h2>
  <div id="postsContainer"></div>
  <div id="loadMore" class="load-more">Scroll to load more‚Ä¶</div>
</div>

<div class="floating-post" id="floatingPost" title="Create post">+</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

import { 
  getFirestore, collection, query, orderBy, limit, startAfter,
  getDocs, doc, onSnapshot, deleteDoc, setDoc, getDoc, addDoc 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.appspot.com",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
onAuthStateChanged(auth, user => currentUser = user);

// ---------- Anonymous Device ID for View Tracking ----------
if (!localStorage.getItem("deviceID")) {
  localStorage.setItem("deviceID", "dev-" + crypto.randomUUID());
}
const deviceID = localStorage.getItem("deviceID");

// ---------- DOM ----------
const postsContainer = document.getElementById('postsContainer');
const loadMoreEl = document.getElementById('loadMore');
const floatingPost = document.getElementById('floatingPost');
floatingPost.addEventListener('click', ()=>location.href='post.html');

const PAGE_SIZE = 6;
let lastVisible = null;
let loading = false;
let finished = false;

const escapeHtml = s => s?.replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])) ?? '';
const formatTime = ts => { try { return ts?.toDate().toLocaleString() || "Just now" } catch { return "Just now" } };

async function getUserProfile(uid){
  const userDoc = await getDoc(doc(db,'users',uid));
  return userDoc.exists() ? userDoc.data() : null;
}

// ==============================
//   RENDER POST CARD
// ==============================
async function renderPostCard(postId, data){
  const card = document.createElement('div');
  card.className = 'post-card';
  card.id = `post-${postId}`;

  const profile = await getUserProfile(data.uid);
  const displayName = profile?.fullName || profile?.displayName || 'Unknown';
  const photoURL = profile?.photoURL || '';

  card.innerHTML = `
    <div class="post-header">
      <div class="avatar" style="${photoURL?'background-image:url('+photoURL+');background-size:cover;background-position:center':''}">
        ${photoURL?'':displayName[0].toUpperCase()}
      </div>

      <div style="flex:1">
        <div class="post-name" data-uid="${data.uid}">${displayName}</div>
        <div class="post-time">${formatTime(data.createdAt)}</div>
      </div>

      ${currentUser?.uid !== data.uid ? `<button class="follow-btn" id="follow-${postId}">Follow</button>` : ""}
    </div>

    <div class="post-text">${escapeHtml(data.text)}</div>
    <div class="post-images" id="img-${postId}"></div>

    <div class="actions">
      <button class="btn like-btn" id="like-${postId}">‚ù§Ô∏è Like</button>
      <span class="likes-count" id="likes-${postId}">0</span>

      <button class="btn comment-btn" id="toggle-${postId}">üí¨ Comment</button>

      <span class="views-count" id="views-${postId}">0 views</span>

      ${currentUser?.uid === data.uid ? `<button class="btn delete-btn" id="del-${postId}">üóë Delete</button>` : ""}
    </div>

    <div class="comments-area" id="carea-${postId}" style="display:none">
      <textarea id="cinput-${postId}" class="comment-input" placeholder="Write a comment‚Ä¶"></textarea>
      <button class="btn comment-btn" id="cpost-${postId}">Post</button>
      <div id="clist-${postId}" class="clist"></div>
    </div>
  `;

  const imgBox = card.querySelector(`#img-${postId}`);
  if(data.mediaUrls?.length){
    data.mediaUrls.forEach(url=>{
      if(url.match(/\.(mp4|webm|ogg)$/)){
        const video = document.createElement('video');
        video.src = url; video.controls = true;
        video.style.maxWidth = data.mediaUrls.length===1?'100%':'48%';
        imgBox.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = url;
        img.style.maxWidth = data.mediaUrls.length===1?'100%':'48%';
        imgBox.appendChild(img);
      }
    });
  }

  // go to profile
  card.querySelector('.post-name').onclick = e=>{
    const uid = e.target.dataset.uid;
    location.href = `profile.html?uid=${uid}`;
  };

  // ------------------------------ LIKE SYSTEM ------------------------------
  const likeBtn = card.querySelector(`#like-${postId}`);
  likeBtn.onclick = async ()=>{
    if(!currentUser) return alert('Login first');
    await setDoc(doc(db,'posts',postId,'likes',currentUser.uid),{likedAt:new Date()});
  };
  onSnapshot(collection(db,'posts',postId,'likes'), snap=>{
    card.querySelector(`#likes-${postId}`).textContent = snap.size;
  });

  // ------------------------------ DELETE ------------------------------
  const delBtn = card.querySelector(`#del-${postId}`);
  if(delBtn){
    delBtn.onclick = async ()=>{
      if(!confirm('Delete this post?')) return;
      await deleteDoc(doc(db,'posts',postId));
      card.remove();
    };
  }

  // ------------------------------ FOLLOW ------------------------------
  const fbtn = card.querySelector(`#follow-${postId}`);
  if(fbtn){
    fbtn.onclick = async ()=>{
      if(!currentUser) return alert('Login');
      const follower = doc(db,'users',data.uid,'followers',currentUser.uid);
      const following = doc(db,'users',currentUser.uid,'following',data.uid);

      const snap = await getDoc(follower);
      if(snap.exists()){ 
        await deleteDoc(follower); 
        await deleteDoc(following); 
        fbtn.textContent='Follow'; 
      } else { 
        await setDoc(follower,{followedAt:new Date()});
        await setDoc(following,{followedAt:new Date()});
        fbtn.textContent='Following'; 
      }
    };
    getDoc(doc(db,'users',data.uid,'followers',currentUser?.uid))
      .then(s=>fbtn.textContent = s.exists()?'Following':'Follow');
  }

  // ------------------------------ COMMENTS ------------------------------
  const carea = card.querySelector(`#carea-${postId}`);
  card.querySelector(`#toggle-${postId}`).onclick = ()=>carea.style.display =
    carea.style.display==='none' ? 'block':'none';

  const list = card.querySelector(`#clist-${postId}`);
  onSnapshot(collection(db,'posts',postId,'comments'),snap=>{
    list.innerHTML='';
    snap.forEach(c=>{
      const d = c.data();
      const div = document.createElement('div');
      div.className='comment-card';
      div.innerHTML=`
        <div style="font-weight:700">${d.name}</div>
        <div style="font-size:12px;color:#666">${formatTime(d.createdAt)}</div>
        <div>${escapeHtml(d.text)}</div>`;
      list.appendChild(div);
    });
  });

  card.querySelector(`#cpost-${postId}`).onclick = async ()=>{
    if(!currentUser) return alert('Login first');
    const txt = card.querySelector(`#cinput-${postId}`).value.trim();
    if(!txt) return;

    await addDoc(collection(db,'posts',postId,'comments'),{
      uid:currentUser.uid,
      name:currentUser.displayName||currentUser.email||'Unknown',
      text:txt,
      createdAt:new Date()
    });
    card.querySelector(`#cinput-${postId}`).value='';
  };

  // ==============================
  //          VIEW COUNTER
  // ==============================
  const viewDocId = currentUser?.uid || deviceID;

  if (!sessionStorage.getItem("viewed-" + postId)) {
    sessionStorage.setItem("viewed-" + postId, "true");

    await setDoc(doc(db, "posts", postId, "views", viewDocId), {
      viewedAt: new Date()
    });
  }

  onSnapshot(collection(db, "posts", postId, "views"), snap => {
    card.querySelector(`#views-${postId}`).textContent = snap.size + " views";
  });

  postsContainer.appendChild(card);
}

// ==============================
//          LOAD POSTS
// ==============================
async function loadPosts(initial=false){
  if(loading || finished) return;
  loading = true;

  let q = query(collection(db,'posts'),orderBy('createdAt','desc'),limit(PAGE_SIZE));
  if(!initial && lastVisible) 
    q = query(collection(db,'posts'),orderBy('createdAt','desc'),
      startAfter(lastVisible),limit(PAGE_SIZE));

  const snap = await getDocs(q);
  if(snap.empty){
    finished = true;
    loadMoreEl.textContent = initial?'No posts yet':'No more posts';
    loading=false;
    return;
  }

  lastVisible = snap.docs[snap.docs.length-1];
  snap.docs.forEach(d=>renderPostCard(d.id,d.data()));
  loading=false;
}

window.addEventListener('scroll',()=>{
  if((window.innerHeight + window.scrollY) >= document.body.offsetHeight-120){
    loadPosts();
  }
});

loadPosts(true);
</script>
</body>
</html>
