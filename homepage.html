<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Homepage</title>
<style>
  :root{--primary:#6e8ef5;--accent:#ff6e6e}
  body{font-family:sans-serif;background:#f4f6ff;margin:0;padding:20px;}
  .hotbar{display:flex;gap:10px;margin-bottom:14px}
  .hotbar button{padding:10px 16px;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer}
  #feed{max-width:800px;margin:0 auto}
  .post-card{background:#fff;padding:16px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-bottom:16px}
  .post-header{display:flex;align-items:center;gap:12px}
  .avatar{width:48px;height:48px;border-radius:999px;background:linear-gradient(135deg,#cfe1ff,#e7dfff);display:flex;align-items:center;justify-content:center;font-weight:700}
  .post-name{font-weight:700;cursor:pointer}
  .post-time{color:#777;font-size:12px}
  .post-text{margin:12px 0;white-space:pre-wrap}
  .post-images{display:flex;gap:8px;overflow:hidden}
  .post-images img{max-height:220px;border-radius:10px;object-fit:cover}
  .actions{margin-top:10px;display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
  .like-btn{background:var(--accent);color:#fff}
  .comment-btn{background:var(--primary);color:#fff}
  .delete-btn{background:#222;color:#fff}
  .likes-count{font-weight:700;margin-left:6px}
  .comments-area{margin-top:10px;border-top:1px solid #eee;padding-top:10px}
  .comment-card{background:#f6f7ff;padding:8px;border-radius:8px;margin-bottom:8px}
  .floating-post{position:fixed;right:22px;bottom:22px;width:58px;height:58px;border-radius:999px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-size:32px;box-shadow:0 8px 24px rgba(0,0,0,.15);cursor:pointer}
  .load-more{padding:12px;text-align:center;color:#555}
  .follow-btn{padding:6px 10px;border-radius:8px;border:none;background:#fff;color:var(--primary);cursor:pointer}
</style>
</head>
<body>

<div class="hotbar">
  <button onclick="location.href='profile.html'">My Profile</button>
  <button onclick="location.href='user.html'">Users</button>
  <button onclick="location.href='post.html'">Create Post</button>
</div>

<div id="feed">
  <h2>Posts</h2>
  <div id="postsContainer"></div>
  <div id="loadMore" class="load-more">Scroll to load more‚Ä¶</div>
</div>

<div class="floating-post" id="floatingPost" title="Create post">+</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy, limit, startAfter,
  getDocs, doc, onSnapshot, deleteDoc, setDoc, getDoc, addDoc
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.firebasestorage.app",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
onAuthStateChanged(auth, u => currentUser = u);

const postsContainer = document.getElementById("postsContainer");
const loadMoreEl = document.getElementById("loadMore");

const PAGE_SIZE = 6;
let lastVisible = null;
let loading = false;
let finished = false;

/* ------------------- Utilities ------------------- */
const escapeHtml = s => s?.replace(/[&<>]/g, m => (
  { "&": "&amp;", "<": "&lt;", ">": "&gt;" }[m]
)) ?? "";

const formatTime = ts => {
  try { return ts?.toDate().toLocaleString() || "Just now" }
  catch { return "Just now" }
};

/* ------------------- Render Post ------------------- */
function renderPostCard(postId, data) {
  const frag = document.createDocumentFragment();

  const card = document.createElement("div");
  card.className = "post-card";
  card.id = `post-${postId}`;

  const avatarInitial = (data.name || "U")[0].toUpperCase();

  card.innerHTML = `
    <div class="post-header">
      <div class="avatar">${avatarInitial}</div>
      <div style="flex:1">
        <div class="post-name" data-uid="${data.uid}">${data.name}</div>
        <div class="post-time">${formatTime(data.createdAt)}</div>
      </div>
      ${currentUser?.uid !== data.uid ? `<button class="follow-btn" id="follow-${postId}">Follow</button>` : ""}
    </div>

    <div class="post-text">${escapeHtml(data.text)}</div>
    <div class="post-images" id="img-${postId}"></div>

    <div class="actions">
      <button class="btn like-btn" id="like-${postId}">‚ù§Ô∏è Like</button>
      <span class="likes-count" id="likes-${postId}">0</span>
      <button class="btn comment-btn" id="toggle-${postId}">üí¨ Comment</button>
      ${currentUser && currentUser.uid === data.uid ? `<button class="btn delete-btn" id="del-${postId}">üóë Delete</button>` : ""}
    </div>

    <div class="comments-area" id="carea-${postId}" style="display:none">
      <textarea id="cinput-${postId}" class="comment-input" placeholder="Write a comment‚Ä¶"></textarea>
      <button class="btn comment-btn" id="cpost-${postId}">Post</button>
      <div id="clist-${postId}" class="clist"></div>
    </div>
  `;

  /* Images */
  if (data.imageUrls?.length) {
    const imgBox = card.querySelector(`#img-${postId}`);
    data.imageUrls.forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      img.style.maxWidth = data.imageUrls.length === 1 ? "100%" : "48%";
      img.loading = "lazy"; // ‚≠ê faster load
      img.onclick = () => window.open(url, "_blank");
      imgBox.appendChild(img);
    });
  }

  /* Profile click */
  card.querySelector(".post-name").onclick = e => {
    const uid = e.target.dataset.uid;
    location.href = `profile.html?uid=${uid}`;
  };

  /* Like system */
  card.querySelector(`#like-${postId}`).onclick = async () => {
    if (!currentUser) return alert("Login first");
    await setDoc(doc(db, "posts", postId, "likes", currentUser.uid), {
      likedAt: new Date()
    });
  };

  /* Delete */
  const del = card.querySelector(`#del-${postId}`);
  if (del) {
    del.onclick = async () => {
      if (!confirm("Delete this post?")) return;
      await deleteDoc(doc(db, "posts", postId));
      card.remove();
    };
  }

  /* Follow */
  const fbtn = card.querySelector(`#follow-${postId}`);
  if (fbtn) {
    fbtn.onclick = async () => {
      if (!currentUser) return alert("Login");

      const follower = doc(db, "users", data.uid, "followers", currentUser.uid);
      const following = doc(db, "users", currentUser.uid, "following", data.uid);

      const snap = await getDoc(follower);
      if (snap.exists()) {
        await deleteDoc(follower);
        await deleteDoc(following);
        fbtn.textContent = "Follow";
      } else {
        await setDoc(follower, { followedAt: new Date() });
        await setDoc(following, { followedAt: new Date() });
        fbtn.textContent = "Following";
      }
    };

    // set initial state (NO repeated DB reads)
    getDoc(doc(db, "users", data.uid, "followers", currentUser?.uid))
      .then(s => fbtn.textContent = s.exists() ? "Following" : "Follow");
  }

  /* Toggle comments */
  const carea = card.querySelector(`#carea-${postId}`);
  card.querySelector(`#toggle-${postId}`).onclick = () => {
    carea.style.display = carea.style.display === "none" ? "block" : "none";
  };

  /* Live likes */
  onSnapshot(collection(db, "posts", postId, "likes"), snap => {
    card.querySelector(`#likes-${postId}`).textContent = snap.size;
  });

  /* Live comments ‚Äî optimized (does NOT re-render the input box every time) */
  const list = card.querySelector(`#clist-${postId}`);
  onSnapshot(collection(db, "posts", postId, "comments"), snap => {
    list.innerHTML = "";
    const f = document.createDocumentFragment();
    snap.forEach(c => {
      const d = c.data();
      const div = document.createElement("div");
      div.className = "comment-card";
      div.innerHTML = `
        <div style="font-weight:700">${d.name}</div>
        <div style="font-size:12px;color:#666">${formatTime(d.createdAt)}</div>
        <div>${escapeHtml(d.text)}</div>
      `;
      f.appendChild(div);
    });
    list.appendChild(f);
  });

  /* Post comment */
  card.querySelector(`#cpost-${postId}`).onclick = async () => {
    if (!currentUser) return alert("Login first");
    const box = card.querySelector(`#cinput-${postId}`);
    const txt = box.value.trim();
    if (!txt) return;

    await addDoc(collection(db, "posts", postId, "comments"), {
      uid: currentUser.uid,
      name: currentUser.displayName || currentUser.email,
      text: txt,
      createdAt: new Date()
    });
    box.value = "";
  };

  frag.appendChild(card);
  postsContainer.appendChild(frag);
}

/* ------------------- Pagination ------------------- */
async function loadInitial() {
  if (loading || finished) return;
  loading = true;

  const q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(PAGE_SIZE));
  const snap = await getDocs(q);

  if (snap.empty) {
    finished = true;
    loadMoreEl.textContent = "No posts yet";
    return;
  }

  lastVisible = snap.docs[snap.docs.length - 1];
  snap.docs.forEach(docSnap => renderPostCard(docSnap.id, docSnap.data()));

  loading = false;
}

async function loadMore() {
  if (loading || finished || !lastVisible) return;
  loading = true;

  const q = query(
    collection(db, "posts"),
    orderBy("createdAt", "desc"),
    startAfter(lastVisible),
    limit(PAGE_SIZE)
  );

  const snap = await getDocs(q);
  if (snap.empty) {
    finished = true;
    loadMoreEl.textContent = "No more posts";
    return;
  }

  lastVisible = snap.docs[snap.docs.length - 1];
  snap.docs.forEach(d => renderPostCard(d.id, d.data()));

  loading = false;
}

/* Infinite scroll */
window.addEventListener("scroll", () => {
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 140) {
    loadMore();
  }
});

loadInitial();
</script>
</body>
</html>
