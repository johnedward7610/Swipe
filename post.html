<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create Post (Max Compression Mode)</title>
  <style>
body{font-family:sans-serif;background:#f4f6ff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
.card{background:#fff;padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);width:420px;position:relative}
textarea{width:100%;height:100px;padding:10px;border-radius:8px;border:1px solid #ddd;resize:vertical}
input[type=file]{margin-top:8px}
.img-preview{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.img-preview img,.img-preview video{height:80px;border-radius:8px;object-fit:cover}
.btn{padding:10px 14px;border:none;border-radius:8px;background:#6e8ef5;color:#fff;cursor:pointer}
.btn.cancel{background:#ddd;color:#222}
.small{font-size:13px;color:#666;margin-top:8px}
.progress{height:8px;background:#eee;border-radius:8px;margin-top:8px;overflow:hidden;position:relative}
.progress i{display:block;height:100%;background:#6e8ef5;width:0%}
.progress span{position:absolute;top:-22px;right:0;font-size:12px;color:#333}
#tagSuggestions{position:absolute;z-index:999;width:360px;max-height:200px;overflow:auto;background:#fff;border:1px solid #ddd;border-radius:8px;display:none}
#tagSuggestions div{padding:8px;cursor:pointer}
#tagSuggestions div:hover{background:#f0f2ff}
  </style>
</head>
<body>
<div class="card">
  <h3>Create a Post</h3>
  <textarea id="postText" placeholder="What's on your mind?"></textarea>
  <div id="tagSuggestions"></div>
  <div class="small">Attach images/videos (max 6)</div>
  <input type="file" id="media" accept="image/*,video/*" multiple />
  <div class="img-preview" id="preview"></div>
  <div class="progress" id="progress" style="display:none">
    <i id="progressbar"></i>
    <span id="progressPct">0%</span>
  </div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button class="btn" id="postBtn">Post</button>
    <button class="btn cancel" id="cancelBtn">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",authDomain:"swipe-f90ed.firebaseapp.com",projectId:"swipe-f90ed",storageBucket:"swipe-f90ed.appspot.com",messagingSenderId:"360540214416",appId:"1:360540214416:web:3e92fe77e5c93283d47415"};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUser=null;
onAuthStateChanged(auth,u=>{currentUser=u});

const postBtn=document.getElementById('postBtn');
const cancelBtn=document.getElementById('cancelBtn');
const mediaInput=document.getElementById('media');
const preview=document.getElementById('preview');
const progressEl=document.getElementById('progress');
const progressBar=document.getElementById('progressbar');
const progressPct=document.getElementById('progressPct');
const postText=document.getElementById('postText');
const tagSuggestions=document.getElementById('tagSuggestions');

let selectedFiles=[];
let allUsers=[];
let detectedTags=[];

async function loadUsers(){
  const snap=await getDocs(collection(db,'users'));
  allUsers=snap.docs.map(d=>({uid:d.id,...d.data()}));
}
loadUsers();

mediaInput.addEventListener('change',e=>{
  selectedFiles=Array.from(e.target.files).slice(0,6);
  preview.innerHTML='';
  selectedFiles.forEach(file=>{
    const url=URL.createObjectURL(file);
    if(file.type.startsWith('video/')){
      const v=document.createElement('video');v.src=url;v.controls=true;preview.appendChild(v);
    }else{
      const img=document.createElement('img');img.src=url;preview.appendChild(img);
    }
  });
});

/* ===================== MAX COMPRESSION ===================== */
function optimizeImage(file,maxWidth=900,quality=0.55){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      let canvas=document.createElement('canvas');
      const ratio=img.width/img.height;
      if(img.width>maxWidth){canvas.width=maxWidth;canvas.height=maxWidth/ratio;}else{canvas.width=img.width;canvas.height=img.height;}
      const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(b=>resolve(new File([b],file.name.replace(/\.[^.]+$/,'.webp'),{type:'image/webp'})),'image/webp',quality);
    };
    img.src=URL.createObjectURL(file);
  });
}

async function optimizeVideo(file,maxMB=8){
  const sizeMB=file.size/1024/1024;
  if(sizeMB<=maxMB)return file;
  const newSize=maxMB*1024*1024;
  const trimmed=file.slice(0,newSize);
  return new File([trimmed],file.name,{type:file.type});
}

/* ===================== Cloudinary Upload ===================== */
async function uploadToCloudinary(file,onProgress){
  const url=`https://api.cloudinary.com/v1_1/dkq1530ap/upload`;
  const formData=new FormData();
  formData.append('file',file);
  formData.append('upload_preset','bc0uzx6v');
  formData.append('transformation','{"quality":"auto","fetch_format":"auto"}');

  return new Promise((resolve,reject)=>{
    const xhr=new XMLHttpRequest();xhr.open('POST',url);
    xhr.upload.onprogress=e=>{if(e.lengthComputable&&onProgress){onProgress(Math.round((e.loaded/e.total)*100));}};
    xhr.onload=()=>{if(xhr.status===200){resolve(JSON.parse(xhr.responseText).secure_url);}else reject(xhr.responseText)};
    xhr.onerror=()=>reject('Upload failed');
    xhr.send(formData);
  });
}

/* ===================== TAGGING ===================== */
postText.addEventListener('keyup',e=>{
  const text=postText.value;
  const cursor=postText.selectionStart;
  const sliced=text.slice(0,cursor);
  const match=sliced.match(/\@([a-zA-Z0-9 _\-.]{1,30})$/);
  if(!match){tagSuggestions.style.display='none';return;}
  const q=match[1].trim().toLowerCase();
  if(!q){tagSuggestions.style.display='none';return;}

  const results=allUsers.filter(u=>{
    const name=(u.fullName||u.displayName||u.email||'').toLowerCase();return name.includes(q);
  }).slice(0,8);

  if(results.length===0){tagSuggestions.style.display='none';return;}

  tagSuggestions.innerHTML='';
  results.forEach(u=>{
    const div=document.createElement('div');
    const label=u.fullName||u.displayName||u.email;
    div.textContent=label;
    div.onclick=()=>{
      const before=text.slice(0,cursor).replace(/\@([a-zA-Z0-9 _\-.]{1,30})$/,`@${label}`);
      postText.value=before+" "+text.slice(cursor);
      detectedTags=[...new Set([...detectedTags,u.uid])];
      tagSuggestions.style.display='none';postText.focus();
    };
    tagSuggestions.appendChild(div);
  });

  const rect=postText.getBoundingClientRect();
  tagSuggestions.style.top=(rect.bottom+window.scrollY+4)+'px';
  tagSuggestions.style.left=(rect.left+window.scrollX)+'px';
  tagSuggestions.style.display='block';
});

/* ===================== POST ===================== */
postBtn.addEventListener('click',async()=>{
  if(!currentUser)return alert('Login first');
  if(!postText.value.trim()&&selectedFiles.length===0)return alert('Write something');

  postBtn.disabled=true;
  progressEl.style.display='block';progressBar.style.width='0%';progressPct.textContent='0%';

  try{
    const postRef=await addDoc(collection(db,'posts'),{
      uid:currentUser.uid,
      name:currentUser.displayName||currentUser.email,
      text:postText.value.trim(),
      createdAt:serverTimestamp(),
      mediaUrls:[],
      tags:detectedTags
    });

    let urls=[];
    for(let i=0;i<selectedFiles.length;i++){
      let file=selectedFiles[i];
      if(file.type.startsWith('image/'))file=await optimizeImage(file,900,0.55);
      if(file.type.startsWith('video/'))file=await optimizeVideo(file,8);

      const url=await uploadToCloudinary(file,p=>{
        const overall=Math.round(((i+p/100)/selectedFiles.length)*100);
        progressBar.style.width=overall+'%';progressPct.textContent=overall+'%';
      });
      urls.push(url);
    }

    await updateDoc(postRef,{mediaUrls:urls});
    progressBar.style.width='100%';progressPct.textContent='100%';

    alert('Post created!');location.href='homepage.html';
  }catch(err){console.error(err);alert('Failed: '+err);postBtn.disabled=false;progressEl.style.display='none';}
});

cancelBtn.addEventListener('click',()=>location.href='homepage.html');
</script>
</body>
</html>
