<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Create Post</title>
<style>
body{font-family:sans-serif;background:#f4f6ff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
.card{background:#fff;padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);width:380px}
textarea{width:100%;height:100px;padding:10px;border-radius:8px;border:1px solid #ddd;resize:vertical}
input[type=file]{margin-top:8px}
.img-preview{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.img-preview img, .img-preview video{height:80px;border-radius:8px;object-fit:cover}
.btn{padding:10px 14px;border:none;border-radius:8px;background:#6e8ef5;color:#fff;cursor:pointer}
.small{font-size:13px;color:#666;margin-top:8px}
.progress{height:8px;background:#eee;border-radius:8px;margin-top:8px;overflow:hidden}
.progress > i{display:block;height:100%;background:#6e8ef5;width:0%}
</style>
</head>
<body>
<div class="card">
  <h3>Create a Post</h3>
  <textarea id="postText" placeholder="What's on your mind?"></textarea>
  <div class="small">Attach images/videos (max 6)</div>
  <input type="file" id="media" accept="image/*,video/*" multiple />
  <div class="img-preview" id="preview"></div>
  <div class="progress" id="progress" style="display:none"><i id="progressbar"></i></div>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button class="btn" id="postBtn">Post</button>
    <button class="btn" style="background:#ddd;color:#222" id="cancelBtn">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.appspot.com",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
onAuthStateChanged(auth, u => {
  currentUser = u;
  if(!u) location.href='index.html';
});

const postBtn = document.getElementById('postBtn');
const cancelBtn = document.getElementById('cancelBtn');
const mediaInput = document.getElementById('media');
const preview = document.getElementById('preview');
const progressEl = document.getElementById('progress');
const progressBar = document.getElementById('progressbar');

let selectedFiles = [];

// Preview media
mediaInput.addEventListener('change', e => {
  selectedFiles = Array.from(e.target.files).slice(0,6); // max 6
  preview.innerHTML = '';
  selectedFiles.forEach(file=>{
    const url = URL.createObjectURL(file);
    if(file.type.startsWith('video/')){
      const video = document.createElement('video');
      video.src = url;
      video.controls = true;
      preview.appendChild(video);
    } else {
      const img = document.createElement('img');
      img.src = url;
      preview.appendChild(img);
    }
  });
});

cancelBtn.addEventListener('click', ()=>location.href='homepage.html');

// Upload to Cloudinary
async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/dkq1530ap/upload`;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'bc0uzx6v');
  
  return new Promise((resolve, reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url);
    
    xhr.upload.onprogress = e => {
      if(e.lengthComputable){
        const pct = (e.loaded / e.total) * 100;
        progressBar.style.width = pct + '%';
      }
    };
    
    xhr.onload = () => {
      if(xhr.status === 200){
        const res = JSON.parse(xhr.responseText);
        resolve(res.secure_url);
      } else reject(xhr.responseText);
    };
    
    xhr.onerror = () => reject('Upload error');
    
    xhr.send(formData);
  });
}

// Post button
postBtn.addEventListener('click', async ()=>{
  const text = document.getElementById('postText').value.trim();
  if(!text && selectedFiles.length===0) return alert('Write something or attach media');

  // Create post first
  const postRef = await addDoc(collection(db,'posts'),{
    uid: currentUser.uid,
    name: currentUser.displayName || currentUser.email,
    text,
    createdAt: serverTimestamp(),
    mediaUrls: []
  });

  if(selectedFiles.length === 0) return location.href='homepage.html';

  progressEl.style.display = 'block';
  const urls = [];
  
  for(let i=0;i<selectedFiles.length;i++){
    const url = await uploadToCloudinary(selectedFiles[i]);
    urls.push(url);
  }

  await updateDoc(postRef,{mediaUrls: urls});
  location.href='homepage.html';
});
</script>
</body>
</html>
