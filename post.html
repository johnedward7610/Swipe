<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Create Post</title>
<style>
  body{font-family:sans-serif;background:#f4f6ff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
  .card{background:#fff;padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);width:380px}
  textarea{width:100%;height:100px;padding:10px;border-radius:8px;border:1px solid #ddd;resize:vertical}
  input[type=file]{margin-top:8px}
  .img-preview{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .img-preview img{height:80px;border-radius:8px;object-fit:cover}
  .btn{padding:10px 14px;border:none;border-radius:8px;background:#6e8ef5;color:#fff;cursor:pointer}
  .small{font-size:13px;color:#666;margin-top:8px}
  .progress{height:8px;background:#eee;border-radius:8px;margin-top:8px;overflow:hidden}
  .progress > i{display:block;height:100%;background:#6e8ef5;width:0%}
</style>
</head>
<body>
  <div class="card">
    <h3>Create a Post</h3>
    <textarea id="postText" placeholder="What's on your mind?"></textarea>
    <div class="small">Attach images (max 6)</div>
    <input type="file" id="images" accept="image/*" multiple />
    <div class="img-preview" id="preview"></div>
    <div class="progress" id="progress" style="display:none"><i id="progressbar"></i></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="postBtn">Post</button>
      <button class="btn" style="background:#ddd;color:#222" id="cancelBtn">Cancel</button>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// üîë Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.appspot.com",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ‚≠ê Cloudinary Config
const CLOUD_NAME = "dkq1530ap";
const UPLOAD_PRESET = "bc0uzx6v";
const CLOUD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

let currentUser = null;
onAuthStateChanged(auth, u => { 
  currentUser = u; 
  if (!u) location.href='index.html'; 
});

const postBtn = document.getElementById('postBtn');
const cancelBtn = document.getElementById('cancelBtn');
const imagesInput = document.getElementById('images');
const preview = document.getElementById('preview');
const progressEl = document.getElementById('progress');
const progressBar = document.getElementById('progressbar');

let selectedFiles = [];

// Preview selected images
imagesInput.addEventListener('change', e => {
  selectedFiles = Array.from(e.target.files).slice(0,6); // max 6
  preview.innerHTML = '';
  selectedFiles.forEach(file => {
    const url = URL.createObjectURL(file);
    const img = document.createElement('img');
    img.src = url;
    preview.appendChild(img);
  });
});

// Cancel button
cancelBtn.addEventListener('click', () => location.href='homepage.html');

// Compress image (same as before)
const compressImage = (file) => new Promise(resolve => {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const maxW = 1000;
      const scale = maxW / img.width;
      canvas.width = maxW;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        resolve(new File([blob], file.name, { type: "image/jpeg" }));
      }, "image/jpeg", 0.75);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
});

// ‚≠ê Upload to Cloudinary
async function uploadToCloudinary(file, index, total) {
  return new Promise(async (resolve, reject) => {
    const form = new FormData();
    form.append("file", file);
    form.append("upload_preset", UPLOAD_PRESET);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", CLOUD_URL, true);

    // Progress bar support
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = e.loaded / e.total;
        const overallPct = ((index + pct) / total) * 100;
        progressBar.style.width = overallPct + "%";
      }
    };

    xhr.onload = () => {
      if (xhr.status === 200) {
        const res = JSON.parse(xhr.responseText);
        resolve(res.secure_url);
      } else reject("Upload failed");
    };

    xhr.onerror = reject;

    xhr.send(form);
  });
}

// ‚≠ê Post button
postBtn.addEventListener('click', async () => {
  const text = document.getElementById('postText').value.trim();
  if (!text && selectedFiles.length === 0) return alert('Write something or attach images');

  // 1Ô∏è‚É£ Create post first
  const postRef = await addDoc(collection(db, "posts"), {
    uid: currentUser.uid,
    name: currentUser.displayName || currentUser.email,
    text,
    createdAt: serverTimestamp(),
    imageUrls: []
  });

  if (selectedFiles.length === 0) return location.href='homepage.html';

  progressEl.style.display = "block";

  // 2Ô∏è‚É£ Upload each file to Cloudinary
  const urls = [];
  const total = selectedFiles.length;

  for (let i = 0; i < total; i++) {
    const compressed = await compressImage(selectedFiles[i]);
    const url = await uploadToCloudinary(compressed, i, total);
    urls.push(url);
  }

  // 3Ô∏è‚É£ Save image URLs into Firestore
  await updateDoc(postRef, { imageUrls: urls });

  // 4Ô∏è‚É£ Done
  location.href='homepage.html';
});
</script>
</body>
</html>
