<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Profile — Dark</title>

<!-- ---- Dark theme + responsive CSS (combined, option C) ---- -->
<style>
  :root{
    --dark-bg: #0f1720;
    --card: #111219;
    --muted: #9aa4b2;
    --accent: #6e8ef5;
    --accent-2: #5A67D8;
    --radius: 12px;
    --gap: 16px;
  }

  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(180deg,#071020 0%, #0b1420 100%);
    color: #e6eef8;
    padding: 20px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Page wrapper */
  #page { max-width: 980px; margin: 0 auto; }

  /* Card */
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.04);
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: 0 8px 30px rgba(2,6,23,0.6);
  }

  /* Top header row */
  .header-row { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }

  .meta { display:flex; gap:12px; align-items:center; min-width:0; }
  .avatar {
    width:84px;height:84px;border-radius:999px;flex:0 0 84px;
    background:linear-gradient(135deg,#2b3bff22,#8b5cf622);
    display:flex;align-items:center;justify-content:center;font-weight:800;font-size:34px;color:#eaf0ff;
    overflow:hidden;position:relative;
    border: 2px solid rgba(255,255,255,0.04);
  }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

  .profile-info{ min-width:0; }
  .profile-info input[type="text"]{
    background:transparent;border:none;color:var(--muted);font-size:20px;font-weight:700;
    outline:none; width:100%;
  }
  .small { color: var(--muted); font-size:13px; margin-top:4px; display:block; }

  /* Buttons */
  .controls { display:flex; gap:8px; flex-wrap:wrap; }
  .btn {
    padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
    background:var(--accent); color:white;
    display:inline-flex;align-items:center;gap:8px;
  }
  .btn.secondary{
    background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted);
  }
  .btn.ghost{
    background:transparent;color:var(--muted);
    border: none;
  }

  /* About & stats */
  #about-grid{ display:grid; grid-template-columns: 1fr 300px; gap:16px; margin-top:16px; align-items:start; }
  .about, .stats { background:transparent; padding:0; }
  .section-title { font-weight:700; font-size:16px; margin:0 0 8px 0; color:#e9f0ff; }
  .muted { color:var(--muted); font-size:14px; margin-top:6px; }

  .stats-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:8px; }
  .stat { background: rgba(255,255,255,0.02); padding:10px; border-radius:10px; text-align:center; }
  .stat .num{ font-weight:800; font-size:18px; color:white; }
  .stat .label{ color:var(--muted); font-size:13px; margin-top:6px; }

  /* Posts area */
  #posts { margin-top:18px; }
  .post-card{
    background: rgba(255,255,255,0.02);
    padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);
  }
  .post-card img, .post-card video { max-height:160px; border-radius:8px; display:block; margin-top:8px; }

  /* Photo grid / showcases */
  .photo-showcase-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px; }
  .photo-item{ background: rgba(255,255,255,0.01); height:80px; border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:600; }

  /* Responsive tweaks */
  @media(min-width:768px){
    .avatar{ width:100px;height:100px; }
    .profile-info input[type="text"]{ font-size:24px; }
    #about-grid{ grid-template-columns: 1fr 360px; }
    .photo-showcase-grid{ grid-template-columns: repeat(6,1fr); }
  }

  @media(max-width:640px){
    #about-grid{ grid-template-columns: 1fr; }
    .stats-grid{ grid-template-columns:repeat(3,1fr); }
    .controls{ width:100%; justify-content:flex-end; }
  }

  .hidden{ display:none!important; }
  .muted-small{ color:var(--muted); font-size:12px; }
</style>
</head>
<body>
<div id="page">
  <div class="card" id="profileCard">
    <div class="header-row">
      <div class="meta">
        <div class="avatar" id="avatar">U</div>
        <div class="profile-info">
          <input type="text" id="nameInput" placeholder="Your name" />
          <div id="email" class="small"></div>
          <div style="margin-top:8px"><span id="followersCount">0</span> followers · <span id="followingCount">0</span> following</div>
        </div>
      </div>

      <div class="controls">
        <button id="followBtn" class="btn">Follow</button>
        <button id="updateBtn" class="btn secondary">Update Profile</button>
        <button id="changePfpBtn" class="btn secondary">Change PFP</button>
        <button id="homeBtn" class="btn ghost">Home</button>
      </div>
    </div>

    <div id="about-grid">
      <div class="about">
        <h3 class="section-title">About Me</h3>
        <p class="muted" id="aboutText">—</p>

        <div style="display:flex;gap:10px;margin-top:14px;">
          <div style="display:flex;flex-direction:column;">
            <small class="muted-small">Location</small>
            <div class="muted" id="location">—</div>
          </div>
          <div style="display:flex;flex-direction:column;">
            <small class="muted-small">Joined</small>
            <div class="muted" id="joined">—</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <h4 class="section-title" style="font-size:14px;margin-bottom:8px;">My Latest Work</h4>
          <div class="photo-showcase-grid" id="workGrid">
            <div class="photo-item">Blank</div>
            <div class="photo-item">Blank</div>
            <div class="photo-item">Blank</div>
            <div class="photo-item hidden">Blank</div>
            <div class="photo-item hidden">Blank</div>
            <div class="photo-item hidden">Blank</div>
          </div>
        </div>
      </div>

      <div class="stats">
        <h3 class="section-title">Quick Stats</h3>
        <div class="stats-grid">
          <div class="stat">
            <div class="num" id="statFollowers">0</div>
            <div class="label">Followers</div>
          </div>
          <div class="stat">
            <div class="num" id="statFollowing">0</div>
            <div class="label">Following</div>
          </div>
          <div class="stat">
            <div class="num" id="statViews">0</div>
            <div class="label">Views this Week</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <button id="editAboutBtn" class="btn secondary" style="width:100%;">Edit About</button>
        </div>
      </div>
    </div>

    <div id="posts">
      <h3 style="margin: 16px 0 8px 0;">Posts</h3>
      <div id="userPosts" class="posts-list card" style="padding:12px; background:transparent; border:none;">Loading posts…</div>
    </div>

    <input type="file" id="pfpInput" style="display:none" accept="image/*"/>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, deleteDoc,
    collection, query, where, orderBy, getDocs
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
    authDomain: "swipe-f90ed.firebaseapp.com",
    projectId: "swipe-f90ed",
    storageBucket: "swipe-f90ed.appspot.com",
    messagingSenderId: "360540214416",
    appId: "1:360540214416:web:3e92fe77e5c93283d47415",
    measurementId: "G-4SV32V4N0N"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const urlParams = new URLSearchParams(window.location.search);
  const profileUid = urlParams.get('uid');

  let currentUser = null;

  const nameInput = document.getElementById('nameInput');
  const emailEl = document.getElementById('email');
  const avatarEl = document.getElementById('avatar');
  const followersCountEl = document.getElementById('followersCount');
  const followingCountEl = document.getElementById('followingCount');
  const followBtn = document.getElementById('followBtn');
  const updateBtn = document.getElementById('updateBtn');
  const userPosts = document.getElementById('userPosts');
  const homeBtn = document.getElementById('homeBtn');
  const changePfpBtn = document.getElementById('changePfpBtn');
  const pfpInput = document.getElementById('pfpInput');
  const aboutText = document.getElementById('aboutText');
  const locationEl = document.getElementById('location');
  const joinedEl = document.getElementById('joined');
  const statFollowers = document.getElementById('statFollowers');
  const statFollowing = document.getElementById('statFollowing');
  const statViews = document.getElementById('statViews');
  const editAboutBtn = document.getElementById('editAboutBtn');

  homeBtn.onclick = () => location.href='homepage.html';

  async function uploadToCloudinary(file){
    const url = `https://api.cloudinary.com/v1_1/dkq1530ap/upload`;
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'bc0uzx6v');
    return new Promise((resolve,reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url);
      xhr.onload = () => {
        if(xhr.status===200) resolve(JSON.parse(xhr.responseText).secure_url);
        else reject('Cloudinary upload failed: ' + xhr.statusText);
      };
      xhr.onerror = ()=>reject('Upload error');
      xhr.send(formData);
    });
  }

  changePfpBtn.onclick = () => pfpInput.click();
  pfpInput.onchange = async (e)=>{
    if(!currentUser) return alert('Login first');
    const file = e.target.files[0];
    if(!file) return;
    try{
      changePfpBtn.disabled = true;
      const url = await uploadToCloudinary(file);
      await updateProfile(currentUser, { photoURL: url });
      await setDoc(doc(db,'users',currentUser.uid), { photoURL:url }, { merge:true });
      avatarEl.style.backgroundImage = `url(${url})`;
      avatarEl.textContent = '';
      alert('Profile picture updated!');
    }catch(err){
      console.error(err); alert('Could not upload: ' + err);
    }finally{ changePfpBtn.disabled=false; }
  };

  async function loadUserPosts(uid) {
    try {
      const postsQuery = query(
        collection(db, 'posts'),
        where('uid', '==', uid),
        orderBy('createdAt', 'desc')
      );
      const postsSnap = await getDocs(postsQuery);
      userPosts.innerHTML = '';
      if (postsSnap.empty) {
        userPosts.textContent = 'No posts yet';
        return;
      }
      postsSnap.forEach(docSnap => {
        const post = docSnap.data();
        const postDiv = document.createElement('div');
        postDiv.className = 'post-card';

        const title = document.createElement('div');
        title.style.fontWeight = '700';
        title.textContent = post.name || (nameInput.value || 'User');
        postDiv.appendChild(title);

        const date = document.createElement('div');
        date.style.fontSize = '12px';
        date.style.color = 'var(--muted)';
        date.style.marginTop = '6px';
        const created = post.createdAt;
        let dt = 'Unknown';
        try {
          dt = created?.seconds
            ? new Date(created.seconds * 1000).toLocaleString()
            : created
            ? new Date(Date.parse(created)).toLocaleString()
            : 'Unknown';
        } catch {}
        date.textContent = dt;
        postDiv.appendChild(date);

        const text = document.createElement('div');
        text.style.marginTop = '8px';
        text.textContent = post.text || '';
        postDiv.appendChild(text);

        if (post.mediaUrls?.length) {
          post.mediaUrls.forEach(url => {
            if (url.match(/\.(mp4|webm|ogg)$/i)) {
              const video = document.createElement('video');
              video.src = url;
              video.controls = true;
              video.style.maxHeight = '160px';
              video.style.borderRadius = '8px';
              video.style.display = 'block';
              video.style.marginTop = '8px';
              postDiv.appendChild(video);
            } else {
              const img = document.createElement('img');
              img.src = url;
              img.style.maxHeight = '160px';
              img.style.borderRadius = '8px';
              img.style.display = 'block';
              img.style.marginTop = '8px';
              postDiv.appendChild(img);
            }
          });
        }

        userPosts.appendChild(postDiv);
      });
    } catch (e) {
      console.error('Could not load posts', e);
      userPosts.textContent = 'Failed to load posts';
    }
  }

  onAuthStateChanged(auth, u => {
    currentUser = u;
    if (!u) { location.href = 'index.html'; return; }
    loadProfile();
  });

  async function loadProfile() {
    const uid = profileUid || (currentUser && currentUser.uid);
    if (!uid) { alert('No user specified'); location.href='index.html'; return; }

    const userDocRef = doc(db, 'users', uid);
    const userDoc = await getDoc(userDocRef);
    const profile = userDoc.exists() ? userDoc.data() : {};

    nameInput.value = profile?.fullName || currentUser?.displayName || '';
    emailEl.textContent = profile?.email || currentUser?.email || '';
    aboutText.textContent = profile?.about || profile?.bio || 'No bio yet.';
    locationEl.textContent = profile?.location || 'Unknown';
    joinedEl.textContent = profile?.joined ? new Date(profile.joined.seconds ? profile.joined.seconds*1000 : profile.joined).toLocaleDateString() : (profile?.createdAt ? new Date(profile.createdAt.seconds?profile.createdAt.seconds*1000:Date.parse(profile.createdAt)).toLocaleDateString() : '—');

    if(profile?.photoURL){
      avatarEl.style.backgroundImage = `url(${profile.photoURL})`;
      avatarEl.textContent = '';
    } else if(currentUser?.photoURL){
      avatarEl.style.backgroundImage = `url(${currentUser.photoURL})`;
      avatarEl.textContent = '';
    } else { avatarEl.style.backgroundImage = ''; avatarEl.textContent = (nameInput.value || 'U')[0].toUpperCase(); }

    try{
      const followersSnap = await getDocs(collection(db, 'users', uid, 'followers'));
      const followingSnap = await getDocs(collection(db, 'users', uid, 'following'));
      followersCountEl.textContent = followersSnap.size;
      followingCountEl.textContent = followingSnap.size;
      statFollowers.textContent = followersSnap
      statFollowers.textContent = followersSnap.size;
      statFollowing.textContent = followingSnap.size;
    } catch(e){
      console.warn('Could not load follow counts', e);
    }

    statViews.textContent = profile?.viewsWeekly || 0;

    if (currentUser && currentUser.uid !== uid) {
      followBtn.style.display = 'inline-flex';
      updateBtn.style.display = 'none';
      changePfpBtn.style.display = 'none';

      const isFollowingSnap = await getDoc(doc(db, 'users', uid, 'followers', currentUser.uid));
      followBtn.textContent = isFollowingSnap.exists() ? 'Following' : 'Follow';
      followBtn.onclick = async () => {
        const followerRef = doc(db, 'users', uid, 'followers', currentUser.uid);
        const followingRef = doc(db, 'users', currentUser.uid, 'following', uid);
        try{
          const snap = await getDoc(followerRef);
          if (snap.exists()) {
            await deleteDoc(followerRef);
            await deleteDoc(followingRef);
            followBtn.textContent = 'Follow';
            followersCountEl.textContent = String(parseInt(followersCountEl.textContent || '0')-1);
            statFollowers.textContent = followersCountEl.textContent;
          } else {
            await setDoc(followerRef,{followedAt:new Date()});
            await setDoc(followingRef,{followedAt:new Date()});
            followBtn.textContent='Following';
            followersCountEl.textContent = String(parseInt(followersCountEl.textContent || '0')+1);
            statFollowers.textContent = followersCountEl.textContent;
          }
        }catch(err){
          console.error('Follow toggle error',err);
        }
      };
    } else {
      followBtn.style.display = 'none';
      updateBtn.style.display = 'inline-flex';
      changePfpBtn.style.display = 'inline-flex';
      updateBtn.onclick = async ()=>{
        const newName = nameInput.value.trim();
        if(!newName) return alert('Name cannot be empty');
        try{
          await updateProfile(currentUser,{displayName:newName});
          await setDoc(doc(db,'users',currentUser.uid),{fullName:newName},{merge:true});
          if(!profile?.photoURL){ avatarEl.textContent = newName[0].toUpperCase(); }
          alert('Profile updated!');
        }catch(err){
          console.error(err); alert('Could not update profile: ' + err.message);
        }
      };
    }

    editAboutBtn.onclick = async ()=>{
      if(!currentUser) return alert('Login first');
      const newAbout = prompt('Update your about / bio', profile?.about || '');
      if(newAbout === null) return;
      try{
        await setDoc(doc(db,'users',currentUser.uid), { about: newAbout }, { merge:true });
        aboutText.textContent = newAbout;
        alert('Bio updated!');
      }catch(e){ console.error(e); alert('Could not update bio'); }
    };

    // **Load posts just like homepage**
    await loadUserPosts(uid);
  }
</script>
</body>
</html>
