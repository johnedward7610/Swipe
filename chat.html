<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
body { font-family: sans-serif; padding: 20px; background: #f4f6ff; }
#messages { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; margin-bottom: 10px; }
.message { padding: 6px 10px; margin: 4px 0; border-radius: 8px; }
.sent { background: #6e8ef5; color: white; text-align: right; }
.received { background: #e0e0e0; color: black; text-align: left; }
#chatInput { width: 80%; padding: 8px; }
#sendBtn { padding: 8px 12px; }
</style>
</head>
<body>

<h2 id="chatWith"></h2>
<div id="messages"></div>
<input type="text" id="chatInput" placeholder="Type a message..." />
<button id="sendBtn">Send</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.firebasestorage.app",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const chatWithUid = localStorage.getItem("chatWithUid");
const chatWithName = localStorage.getItem("chatWithName");

const chatWithElem = document.getElementById("chatWith");
const messagesDiv = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

chatWithElem.textContent = "Chat with " + chatWithName;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const currentUid = user.uid;
  const chatId = [currentUid, chatWithUid].sort().join("_");
  const messagesRef = collection(db, "chats", chatId, "messages");
  const q = query(messagesRef, orderBy("timestamp", "asc"));

  // Real-time listener
  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const m = doc.data();
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(m.sender === currentUid ? "sent" : "received");
      div.textContent = m.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // Send message
  sendBtn.addEventListener("click", async () => {
    const text = chatInput.value.trim();
    if (text === "") return;
    await addDoc(messagesRef, {
      sender: currentUid,
      receiver: chatWithUid,
      text: text,
      timestamp: serverTimestamp()
    });
    chatInput.value = "";
  });
});
</script>

</body>
</html>
