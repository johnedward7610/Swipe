<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
body {
  font-family: "Inter", sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #dfe7ff, #f4f6ff);
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#chatWith {
  margin: 0;
  padding: 15px;
  background: #6e8ef5;
  color: white;
  text-align: center;
  font-size: 22px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  position: sticky;
  top: 0;
  z-index: 10;
}

#messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.message {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 15px;
  word-break: break-word;
  animation: fadeIn 0.2s ease-in-out;
}

.sent {
  align-self: flex-end;
  background: #6e8ef5;
  color: white;
  border-bottom-right-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.received {
  align-self: flex-start;
  background: #ffffff;
  color: #333;
  border-bottom-left-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.message img {
  max-width: 200px;
  border-radius: 10px;
  margin-top: 5px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

.input-area {
  display: flex;
  gap: 10px;
  padding: 15px;
  background: #ffffffee;
  backdrop-filter: blur(6px);
  box-shadow: 0 -3px 10px rgba(0,0,0,0.1);
}

#chatInput {
  flex: 1;
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 20px;
  outline: none;
  font-size: 15px;
  background: #fafafa;
}

#chatInput:focus {
  border-color: #6e8ef5;
  background: white;
}

#sendBtn, #photoBtn {
  padding: 12px 18px;
  border: none;
  border-radius: 20px;
  background: #6e8ef5;
  color: white;
  font-size: 15px;
  cursor: pointer;
  transition: 0.2s;
}

#sendBtn:hover, #photoBtn:hover {
  background: #5a78d8;
}

#photoInput {
  display: none;
}
</style>
</head>
<body>

<h2 id="chatWith"></h2>

<div id="messages"></div>

<div class="input-area">
  <button id="photoBtn">ðŸ“·</button>
  <input type="file" id="photoInput" accept="image/*">
  <input type="text" id="chatInput" placeholder="Type a message..." />
  <button id="sendBtn">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.firebasestorage.app",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const chatWithUid = localStorage.getItem("chatWithUid");
const chatWithName = localStorage.getItem("chatWithName");

const chatWithElem = document.getElementById("chatWith");
const messagesDiv = document.getElementById("messages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const photoBtn = document.getElementById("photoBtn");
const photoInput = document.getElementById("photoInput");

chatWithElem.textContent = "Chat with " + chatWithName;

// Optional: Cloudinary image upload
async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/dkq1530ap/upload`;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', 'bc0uzx6v');
  const res = await fetch(url, { method: "POST", body: formData });
  const data = await res.json();
  return data.secure_url;
}

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";

  const currentUid = user.uid;
  const chatId = [currentUid, chatWithUid].sort().join("_");
  const messagesRef = collection(db, "chats", chatId, "messages");
  const q = query(messagesRef, orderBy("timestamp", "asc"));

  // Listen to messages in real-time
  onSnapshot(q, (snapshot) => {
    messagesDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const m = doc.data();
      const div = document.createElement("div");
      div.classList.add("message", m.sender === currentUid ? "sent" : "received");
      if (m.text) div.textContent = m.text;
      if (m.imageUrl) {
        const img = document.createElement("img");
        img.src = m.imageUrl;
        div.appendChild(img);
      }
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // Send text messages
  sendBtn.addEventListener("click", async () => {
    const text = chatInput.value.trim();
    if (!text) return;

    await addDoc(messagesRef, {
      sender: currentUid,
      receiver: chatWithUid,
      text,
      timestamp: serverTimestamp()
    });

    chatInput.value = "";
  });

  // Upload image
  photoBtn.addEventListener("click", () => photoInput.click());
  photoInput.addEventListener("change", async () => {
    const file = photoInput.files[0];
    if (!file) return;

    const imgURL = await uploadToCloudinary(file);

    await addDoc(messagesRef, {
      sender: currentUid,
      receiver: chatWithUid,
      imageUrl: imgURL,
      timestamp: serverTimestamp()
    });

    photoInput.value = "";
  });
});
</script>

</body>
</html>
