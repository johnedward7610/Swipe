<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notifications</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6ff; }
h2, h3 { color: #333; }
table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px; }
th, td { padding: 12px; border-bottom: 1px solid #ccc; }
th { background: #6e8ef5; color: white; text-align: left; }
tr:hover { background: #e0e0ff; }
.newNotification { background-color: #fff3c4 !important; }
.newMessage { background-color: #ffd6d6 !important; animation: pulse 1s ease infinite alternate; }
@keyframes pulse { 0% { box-shadow: 0 0 5px #ff4c4c; } 100% { box-shadow: 0 0 15px #ff4c4c; } }
button { padding: 8px 14px; border: none; border-radius: 8px; background: #6e8ef5; color: white; cursor: pointer; margin-right: 5px; }
button:hover { background: #8ea2ff; }
a { text-decoration: none; color: black; display: flex; align-items: center; gap: 10px; }
img { border-radius: 50%; width: 40px; height: 40px; object-fit: cover; }
#errorBox { color: red; font-weight: bold; margin-top: 20px; }
.notificationBadge { background: red; color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 5px; }
</style>
</head>
<body>

<h2>Notifications <span id="friendRequestBadge" style="display:none;" class="notificationBadge">0</span></h2>
<button id="logoutBtn">Log Out</button>
<p id="loading">Loading notifications...</p>
<p id="errorBox"></p>

<h3>Friend Requests</h3>
<table id="friendRequestTable" style="display:none;">
  <thead>
    <tr>
      <th>From</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="friendRequestRows"></tbody>
</table>

<h3>Accepted Requests</h3>
<table id="acceptedTable" style="display:none;">
  <thead>
    <tr>
      <th>Friend</th>
      <th>Chat</th>
    </tr>
  </thead>
  <tbody id="acceptedRows"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc, serverTimestamp, documentId, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-messaging.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.firebasestorage.app",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const messaging = getMessaging(app);

const loadingText = document.getElementById("loading");
const errorBox = document.getElementById("errorBox");
const logoutBtn = document.getElementById("logoutBtn");
const friendRequestTable = document.getElementById("friendRequestTable");
const friendRequestRows = document.getElementById("friendRequestRows");
const acceptedTable = document.getElementById("acceptedTable");
const acceptedRows = document.getElementById("acceptedRows");
const friendRequestBadge = document.getElementById("friendRequestBadge");

// Logout
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "index.html";
});

// FCM setup
async function setupFCM(user) {
  try {
    const permission = await Notification.requestPermission();
    if (permission === "granted") {
      const token = await getToken(messaging, { vapidKey: "BLvAF9-7nR6TCYapQqOUmZHZRLz7m7MjnEPw7I4TUZqFG_98oA41mR-9kN07c4R34_y6mXXvpmlwozFK4ISwfLo" });
      if (token) {
        await updateDoc(doc(db, "users", user.uid), { fcmToken: token });
      }
    }
  } catch (err) { console.error("FCM error:", err); }
}

onMessage(messaging, payload => {
  const { title, body, icon } = payload.notification;
  new Notification(title, { body, icon: icon || "https://www.gravatar.com/avatar/?d=mp" });
  friendRequestTable.style.border = "2px solid #ffcc00";
});

onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href = "index.html";
  await setupFCM(user);
  const uid = user.uid;

  // --- Friend Requests ---
  const reqCol = collection(db, "friendRequests");
  const reqQuery = query(reqCol, where("to", "==", uid), where("status", "==", "pending"));
  onSnapshot(reqQuery, async snapshot => {
    friendRequestRows.innerHTML = "";
    const newCount = snapshot.size;
    const fromUids = snapshot.docs.map(docSnap => docSnap.data().from);
    const uniqueFromUids = [...new Set(fromUids)];
    const usersMap = {};

    if (uniqueFromUids.length > 0) {
      const usersSnap = await getDocs(query(collection(db, "users"), where(documentId(), "in", uniqueFromUids)));
      usersSnap.forEach(d => {
        const data = d.data();
        usersMap[d.id] = {
          name: data.name || "Unknown",
          photoURL: data.photoURL || "https://www.gravatar.com/avatar/?d=mp"
        };
      });
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const fromData = usersMap[data.from] || { name: "Unknown", photoURL: "https://www.gravatar.com/avatar/?d=mp" };
      const tr = document.createElement("tr");
      tr.classList.add("newNotification");
      tr.innerHTML = `
        <td><a href="profile.html?uid=${data.from}"><img src="${fromData.photoURL}" alt="profile"><span>${fromData.name}</span></a></td>
        <td><button class="acceptBtn">Accept</button><button class="declineBtn">Decline</button></td>
      `;
      const acceptBtn = tr.querySelector(".acceptBtn");
      const declineBtn = tr.querySelector(".declineBtn");

      acceptBtn.addEventListener("click", async () => {
        await updateDoc(doc(db, "friendRequests", docSnap.id), { status: "accepted", acceptedAt: serverTimestamp() });
        tr.remove();
        loadAccepted(uid);
      });
      declineBtn.addEventListener("click", async () => {
        await updateDoc(doc(db, "friendRequests", docSnap.id), { status: "declined" });
        tr.remove();
      });

      friendRequestRows.appendChild(tr);
    });

    friendRequestTable.style.display = snapshot.empty ? "none" : "table";
    friendRequestBadge.style.display = newCount ? "inline" : "none";
    friendRequestBadge.innerText = newCount;
  });

  // --- Accepted Friends ---
  async function loadAccepted(uid) {
    const acceptedQuery = query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "accepted"));
    const snapshot = await getDocs(acceptedQuery);
    acceptedRows.innerHTML = "";
    const friendUids = snapshot.docs.map(docSnap => docSnap.data().from);
    const uniqueFriendUids = [...new Set(friendUids)];
    const usersMap = {};

    if (uniqueFriendUids.length > 0) {
      const usersSnap = await getDocs(query(collection(db, "users"), where(documentId(), "in", uniqueFriendUids)));
      usersSnap.forEach(d => {
        const data = d.data();
        usersMap[d.id] = { name: data.name || "Unknown", photoURL: data.photoURL || "https://www.gravatar.com/avatar/?d=mp" };
      });
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const fromData = usersMap[data.from] || { name: "Unknown", photoURL: "https://www.gravatar.com/avatar/?d=mp" };
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><a href="profile.html?uid=${data.from}"><img src="${fromData.photoURL}" alt="profile"><span>${fromData.name}</span></a></td>
        <td><button class="chatBtn">Chat</button></td>
      `;
      const chatBtn = tr.querySelector(".chatBtn");
      chatBtn.addEventListener("click", () => {
        localStorage.setItem("chatWithUid", data.from);
        localStorage.setItem("chatWithName", fromData.name);
        window.location.href = "chat.html";
        tr.classList.remove("newMessage");
      });
      acceptedRows.appendChild(tr);
    });

    acceptedTable.style.display = snapshot.empty ? "none" : "table";
  }

  loadAccepted(uid);

  // --- Incoming messages highlight ---
  const chatsCol = collection(db, "chats");
  onSnapshot(chatsCol, snapshot => {
    snapshot.docs.forEach(chatDoc => {
      const chatId = chatDoc.id;
      const participants = chatId.split("_");
      if (!participants.includes(uid)) return;

      const messagesCol = collection(db, `chats/${chatId}/messages`);
      onSnapshot(messagesCol, msgSnap => {
        msgSnap.docChanges().forEach(change => {
          if (change.type === "added") {
            const message = change.doc.data();
            if (message.sender !== uid) {
              const otherUid = participants.find(p => p !== uid);
              const rows = acceptedRows.querySelectorAll("tr");
              rows.forEach(row => {
                const link = row.querySelector("a");
                if (link && link.href.includes(otherUid)) {
                  row.classList.add("newMessage");
                }
              });
            }
          }
        });
      });
    });
  });

  loadingText.style.display = "none";
});
</script>
</body>
</html>
