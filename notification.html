<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notifications</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6ff; }
h2, h3 { color: #333; }
table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 20px; }
th, td { padding: 12px; border-bottom: 1px solid #ccc; }
th { background: #6e8ef5; color: white; text-align: left; }
tr:hover { background: #e0e0ff; }
button { padding: 8px 14px; border: none; border-radius: 8px; background: #6e8ef5; color: white; cursor: pointer; margin-right: 5px; }
button:hover { background: #8ea2ff; }
a { text-decoration: none; color: black; display: flex; align-items: center; gap: 10px; }
img { border-radius: 50%; width: 40px; height: 40px; object-fit: cover; }
.chatting { background-color: #fff7d6 !important; } /* highlight active chat */
#errorBox { color: red; font-weight: bold; margin-top: 20px; }
</style>
</head>
<body>

<h2>Notifications</h2>
<button onclick="location.href='msglist.html'">messages</button>
<p id="loading">Loading notifications...</p>
<p id="errorBox"></p>

<h3>Friend Requests</h3>
<table id="friendRequestTable" style="display:none;">
  <thead>
    <tr>
      <th>From</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="friendRequestRows"></tbody>
</table>

<h3>Accepted Requests</h3>
<table id="acceptedTable" style="display:none;">
  <thead>
    <tr>
      <th>Friend</th>
      <th>Chat</th>
    </tr>
  </thead>
  <tbody id="acceptedRows"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc, serverTimestamp, documentId } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCRS5SkPr3yGTiHsuY3Bk3IyuS8k88O878",
  authDomain: "swipe-f90ed.firebaseapp.com",
  projectId: "swipe-f90ed",
  storageBucket: "swipe-f90ed.firebasestorage.app",
  messagingSenderId: "360540214416",
  appId: "1:360540214416:web:3e92fe77e5c93283d47415",
  measurementId: "G-4SV32V4N0N"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loadingText = document.getElementById("loading");
const errorBox = document.getElementById("errorBox");
const logoutBtn = document.getElementById("logoutBtn");
const friendRequestTable = document.getElementById("friendRequestTable");
const friendRequestRows = document.getElementById("friendRequestRows");
const acceptedTable = document.getElementById("acceptedTable");
const acceptedRows = document.getElementById("acceptedRows");

// ðŸ”¹ Logout
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "index.html";
});

// ðŸ”¹ Load notifications
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  try {
    const uid = user.uid;

    // ----------------------
    // Friend Requests
    // ----------------------
    const requestQuery = query(
      collection(db, "friendRequests"),
      where("to", "==", uid),
      where("status", "==", "pending")
    );
    const requestSnapshot = await getDocs(requestQuery);
    friendRequestRows.innerHTML = "";

    const fromUids = requestSnapshot.docs.map(docSnap => docSnap.data().from);
    const uniqueFromUids = [...new Set(fromUids)];

    // ðŸ”¹ Fetch user info
    const usersMap = {};
    if (uniqueFromUids.length > 0) {
      const usersQuery = query(collection(db, "users"), where(documentId(), "in", uniqueFromUids));
      const usersSnapshot = await getDocs(usersQuery);
      usersSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        usersMap[docSnap.id] = {
          name: data.fullName || "Unknown",
          photoURL: data.photoURL || "https://www.gravatar.com/avatar/?d=mp"
        };
      });
    }

    // ðŸ”¹ Render friend requests
    if (!requestSnapshot.empty) {
      requestSnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const fromData = usersMap[data.from] || { name: "Unknown", photoURL: "https://www.gravatar.com/avatar/?d=mp" };

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <a href="profile.html?uid=${data.from}">
              <img src="${fromData.photoURL}" alt="profile">
              <span>${fromData.name}</span>
            </a>
          </td>
          <td>
            <button class="acceptBtn">Accept</button>
            <button class="declineBtn">Decline</button>
          </td>
        `;

        const acceptBtn = tr.querySelector(".acceptBtn");
        const declineBtn = tr.querySelector(".declineBtn");

        acceptBtn.addEventListener("click", async () => {
          await updateDoc(doc(db, "friendRequests", docSnap.id), {
            status: "accepted",
            acceptedAt: serverTimestamp()
          });
          tr.remove();
          loadAccepted(uid); // refresh accepted friends
        });

        declineBtn.addEventListener("click", async () => {
          await updateDoc(doc(db, "friendRequests", docSnap.id), { status: "declined" });
          tr.remove();
        });

        friendRequestRows.appendChild(tr);
      });
      friendRequestTable.style.display = "table";
    }

    // ----------------------
    // Accepted Friends
    // ----------------------
    loadAccepted(uid);

    loadingText.style.display = "none";

  } catch (err) {
    loadingText.style.display = "none";
    errorBox.innerText = "ERROR: " + err.message;
    console.error(err);
  }
});

// ----------------------
// Load accepted friends
// ----------------------
async function loadAccepted(uid) {
  const acceptedQuery = query(
    collection(db, "friendRequests"),
    where("status", "==", "accepted"),
    where("to", "==", uid)
  );
  const snapshot = await getDocs(acceptedQuery);
  acceptedRows.innerHTML = "";

  const friendUids = snapshot.docs.map(docSnap => docSnap.data().from);
  const uniqueFriendUids = [...new Set(friendUids)];

  // ðŸ”¹ Fetch friend user info
  const usersMap = {};
  if (uniqueFriendUids.length > 0) {
    const usersQuery = query(collection(db, "users"), where(documentId(), "in", uniqueFriendUids));
    const usersSnapshot = await getDocs(usersQuery);
    usersSnapshot.forEach(docSnap => {
      const data = docSnap.data();
      usersMap[docSnap.id] = {
        name: data.fullName || "Unknown",
        photoURL: data.photoURL || "https://www.gravatar.com/avatar/?d=mp"
      };
    });
  }

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const fromData = usersMap[data.from] || { name: "Unknown", photoURL: "https://www.gravatar.com/avatar/?d=mp" };

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <a href="profile.html?uid=${data.from}">
          <img src="${fromData.photoURL}" alt="profile">
          <span>${fromData.name}</span>
        </a>
      </td>
      <td><button class="chatBtn">Chat</button></td>
    `;

    const chatBtn = tr.querySelector(".chatBtn");
    chatBtn.addEventListener("click", () => {
      localStorage.setItem("chatWithUid", data.from);
      localStorage.setItem("chatWithName", fromData.name);
      window.location.href = "chat.html";
    });

    // ðŸ”¹ Highlight if currently chatting
    const currentChatUid = localStorage.getItem("chatWithUid");
    if (currentChatUid === data.from) {
      tr.classList.add("chatting");
    }

    acceptedRows.appendChild(tr);
  });

  acceptedTable.style.display = snapshot.empty ? "none" : "table";
}
</script>
</body>
</html>
